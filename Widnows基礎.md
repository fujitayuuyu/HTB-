# 1 Windows OSの導入

## (1) Windows 10までのバージョン番号
| オペレーティング システム名                    | バージョン番号 |
|--------------------------------|-------------|
| Windows NT4                    | 4.0         |
| Windows 2000                   | 5.0         |
| Windows XP                     | 5.1         |
| Windows Server 2003, 2003 R2    | 5.2         |
| Windows Vista, Server 2008      | 6.0         |
| Windows 7, Server 2008 R2       | 6.1         |
| Windows 8, Server 2012          | 6.2         |
| Windows 8.1, Server 2012 R2     | 6.3         |
| Windows 10, Server 2016, Server 2019 | 10.0        |

* 以下のコマンドで確認できる
> ```
> ◇ PowerShell
> Get-WmiObject -Class win32_OperatingSystem | select Version,BuildNumber
> 
> ◇ Cmd(DOS)
> systeminfo
> ```

* Windows の多くのバージョンは現在「レガシー」とみなされ、サポートされなくなりました。組織では、重要なアプリケーションをサポートするため、または運用上や予算上の懸念から、さまざまな古いオペレーティング システムを実行していることがよくあります。評価者は、バージョン間の違いと、各バージョンに固有のさまざまな構成ミスや脆弱性を理解する必要がある。

## (2) Windowsへのリモートアクセス
最も一般的なリモート アクセス テクノロジには、次のものがありますが、これらに限定されない。

* 仮想プライベートネットワーク (VPN)???リモートアクセスなのか
* セキュア シェル (SSH) : tcp/22
* ファイル転送プロトコル (FTP) : tcp/20,21
* 仮想ネットワークコンピューティング (VNC) : tcp/5900以降
* Windows リモート管理 (または PowerShell リモート処理) (WinRM) 
> ```
> ◇ windows 7以降
> WinRM HTTP : tcp/5985 , WinRM HTTPS : tcp/5985
>
> ◇ windows 7以前
> WinRM HTTP : tcp/80 , WinRM HTTPS : tcp/443
> ```
* リモート デスクトップ プロトコル (RDP) : tcp/3389

### ① RDPによるWindowsへのアクセス
* Windows : デフォルトで搭載のRDPアプリケーションを利用
* Linux : xfreerdpを利用
> ```
> xfreerdp /v:$IP /u:$USER /p:$PASS

# 2 オペレーティングシステムのコア
## (1) Windows OSのディレクトリ構造
ルート ディレクトリは <ドライブ文字>:\ (通常は C ドライブ) だよ。

| Directory              | Function                                                                                                                 |
|------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Perflogs               | Windowsのパフォーマンスログを保存することができるが、デフォルトでは空である。|
| Program Files          | 32ビットシステムでは、すべての16ビットおよび32ビットプログラムがここにインストールされる。64ビットシステムでは、64ビットプログラムのみがここにインストールされる。             |
| Program Files (x86)    | 64ビット版のWindowsでは、32ビットおよび16ビットのプログラムがここにインストールされる。|
| ProgramData            | インストールされている特定のプログラムが動作するために必要なデータを含む隠しフォルダー。このデータは、どのユーザーが実行してもプログラムからアクセス可能である。|
| Users                  | このフォルダーには、システムにログオンする各ユーザーのプロファイルが含まれており、PublicとDefaultの2つのフォルダーも含まれる。 |
| Default                | 作成されるすべてのユーザーのデフォルトのユーザープロファイルテンプレート。新しいユーザーが追加されると、そのプロファイルはDefaultプロファイルに基づく。 |
| Public                 | コンピュータユーザーがファイルを共有するためのフォルダーで、デフォルトで全ユーザーがアクセス可能。このフォルダーはネットワーク上で共有されるが、有効なネットワークアカウントが必要。|
| AppData                | 各ユーザーのアプリケーションデータと設定は、隠しユーザーサブフォルダー（例：cliff.moore\AppData）に保存される。Roamingはユーザープロファイルに依存しないデータを含み、Localはコンピュータ固有のデータでネットワークを通じて同期されない。LocalLowは、データ整合性が低い場合に使用される。    |
| Windows                | Windowsオペレーティングシステムに必要なファイルの大部分がここに保存される。|
| System, System32, SysWOW64 | Windowsのコア機能およびWindows APIに必要なすべてのDLLが含まれている。プログラムが絶対パスを指定せずにDLLをロードしようとするたびに、オペレーティングシステムはこれらのフォルダーを検索する。 |
| WinSxS                 | Windowsコンポーネントストアには、すべてのWindowsコンポーネント、更新プログラム、およびサービスパックのコピーが保存されている。|

* コマンドラインを利用してディレクトリ探索
> ```
> ◇ ディレクトリ上のすべてのファイルの一覧を表示($から始まるファイルも表示する)
> dir %DIR% /a
>
> ◇ ディレクトリ構造を枝木にして表示
> tree %DIR%
>
> もうちょっと見やすくするとこれ
> tree c:\ /f | more
> ```

## (2) ファイルシステム
Windows ファイル システムには、FAT12、FAT16、FAT32、NTFS、exFAT の 5 種類があります。FAT12 と FAT16 は、最新の Windows オペレーティング システムでは使用されなくなっているよ
### ① FAT32
FAT32 (ファイル アロケーション テーブル) は、USB メモリ スティックや SD カードなど、さまざまな種類のストレージ デバイスで広く使用されていますが、ハード ドライブのフォーマットにも使用できます。名前の「32」は、FAT32 がストレージ デバイス上のデータ クラスターを識別するために 32 ビットのデータを使用するということを示すよ。
* Pros of FAT32:
  *  デバイスの互換性 - コンピューター、デジタルカメラ、ゲーム機、スマートフォン、タブレットなどで使用できます。
  * オペレーティング システムの相互互換性 - Windows 95 以降のすべての Windows オペレーティング システムで動作し、MacOS および Linux でもサポートされているよ。
* Cons of FAT32:
  * 4GB未満のファイルでのみ使用できます。
  * データ保護機能やファイル圧縮機能は組み込まれていません。
  * ファイルの暗号化にはサードパーティのツールを使用する必要があります。
### ② NTFS
NTFS (New Technology File System) は、Windows NT 3.1 以降のデフォルトの Windows ファイル システムです。FAT32 の欠点を補うだけでなく、NTFS はメタデータのサポートが強化され、データ構造が改善されたためパフォーマンスも向上しているよ
* Pros of NTFS:
  * NTFS は信頼性が高く、システム障害や停電が発生した場合でもファイル システムの一貫性を復元できます。
  * ファイルとフォルダーの両方にきめ細かな権限を設定できるようにすることで、セキュリティを確保します。
  * 非常に大きなサイズのパーティションをサポートします。
  * ジャーナリング機能が組み込まれているため、ファイルの変更 (追加、変更、削除) がログに記録されます。
* Cons of NTFS:
  * ほとんどのモバイル デバイスは NTFS をネイティブにサポートしていません。
  * テレビやデジタル カメラなどの古いメディア デバイスでは、NTFS ストレージ デバイスはサポートされていません。

### ③ NTFSでの権限
以下のようにNTFS ファイル システムには、多くの基本権限と高度な権限がある。
| Permission Type        | Description|
|------------------------|----------------------------------------------------------------------------------------|
| Full Control           | ファイルやフォルダーの読み取り、書き込み、変更、削除を許可する。 |
| Modify                 | ファイルやフォルダーの読み取り、書き込み、削除を許可する。                 |
| List Folder Contents    | フォルダーやサブフォルダーの表示とリスト、およびファイルの実行を許可する。この権限はフォルダーにのみ継承される。|
| Read and Execute       | ファイルやサブフォルダーの表示とリスト、およびファイルの実行を許可する。ファイルとフォルダーにこの権限が継承される。|
| Write                  | フォルダーやサブフォルダーにファイルを追加し、ファイルへの書き込みを許可する。|
| Read                   | フォルダーやサブフォルダーの表示とリスト、およびファイルの内容の表示を許可する。 |
| Traverse Folder        | フォルダーを移動して他のファイルやフォルダーにアクセスする能力を許可または禁止する。例えば、c:\users\bsmith\documents\webapps\backups\backup_02042020.zip のディレクトリ内のコンテンツをリスト表示したり、ファイルを表示する権限がない場合でも、「フォルダーの移動」権限が適用されていれば、バックアップアーカイブにアクセスできる。 |


### ④ icaclsを用いたNTFSアクセス制御エントリの操作
Windows のファイルとフォルダーの NTFS アクセス許可は、セキュリティ タブのファイル エクスプローラー GUI を使用して管理できます。GUI とは別に、icacls(Integrity Control Access Control List)ユーティリティを使用してコマンド ラインから Windows の NTFS ファイル アクセス許可をきめ細かく管理することもできるよ。
* 参考サイト：https://learn.microsoft.com/ja-jp/windows-server/administration/windows-commands/icacls

* NTFSアクセス許可の表示形式
> ```
> < OBJECT(Group,Service,User) >:< リソースアクセスレベルや基本的なアクセス権限 >
> ```

* 例 1：icaclsによるNTFSアクセス制御エントリの設定を表示
> ```
> C:\htb> icacls c:\windows
> c:\windows NT SERVICE\TrustedInstaller:(F)
>            NT SERVICE\TrustedInstaller:(CI)(IO)(F)
>            NT AUTHORITY\SYSTEM:(M)
>            NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
>            BUILTIN\Administrators:(M)
>            BUILTIN\Administrators:(OI)(CI)(IO)(F)
>            BUILTIN\Users:(RX)
>            BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
>            CREATOR OWNER:(OI)(CI)(IO)(F)
>            APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
>            APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
>            APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)
>            APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
> 
> Successfully processed 1 files; Failed processing 0 files
> ```
各グループ、サービス、ユーザごとに権限を割り当てているのが分かる

* 例 2：icaclsによるjoeユーザへの`C:\Users`へのディレクトリに関するフルアクセス権の付与
> ```
> icacls c:\users /grant joe:f
> ```

* 例 3：joeユーザへの`C:\Users`へのディレクトリに関するアクセス権の取り消し
> ```
> icacls c:\users /remove joe
> ```
#### リソースアクセスレベルの設定の表示
* (CI): コンテナ継承 - フォルダ内のフォルダにもそのアクセス制御エントリが適用されるよ
* (OI): オブジェクト継承 - フォルダ内のファイルにもそのアクセス制御エントリが適用されるよ
* (IO): 継承のみ - 親コンテナーから現コンテナーは、アクセス制御エントリを継承する
* (NP): 継承を伝播しない - 上から継承されるはずのアクセス制御エントリを適用しない
* (I): 親コンテナから継承された権限 - 親コンテナから継承されたアクセス制御エントリを自分の配下のコンテナに適用しない。

##### 用語説明
* コンテナ：オブジェクトとかコンテナを入れられるものだよ。フォルダとして考えたらいいと思う
* オブジェクト：ファイルやプロセス、リソース、ユーザのことだよ。今回は、ファイルとして考えたらわかりやすいよ。

#### 基本的なアクセス権限の表示
* F : フルアクセス
* D : 削除アクセス
* N : アクセス不可
* M : アクセスの変更
* RX : 読み取りおよび実行アクセス
* R : 読み取り専用アクセス
* W: 書き込み専用アクセス

## (3) NTFSと共有アクセス許可
* Server Message Block protocol(SMB) - Windows でファイルやプリンターなどの共有リソースを接続するために使用される。
* Windows 用に作成されたマルウェアの多くの亜種は、緩いアクセス許可が適用されたネットワーク共有を介してネットワーク上に拡散する可能性がある。また、パッチが適用されていないWindowsシステムのSMBv1に対するEternalBlue脆弱性を突いた攻撃とかもある。

* 大規模、中規模、小規模のエンタープライズ環境で使用される。以下は、簡単にしたSMBによるリソース共有の図
![image](https://github.com/user-attachments/assets/8c47bc59-2780-4465-ad69-60038fcbe761)

### ① 共有権限とNTFS 基本権限
NTFS アクセス許可と共有アクセス許可は、多くの場合同じものと理解されています。これらは同じではありませんが、多くの場合、同じ共有リソースに適用されることに注意。
* 共有権限
| 許可          | 説明                                                                                               |
|---------------|----------------------------------------------------------------------------------------------------|
| Full Control  | ユーザーは、変更および読み取り権限によって与えられたすべてのアクションを実行でき、NTFSファイルとサブフォルダの権限も変更できる。 |
| Change        | ユーザーはファイルとサブフォルダの読み取り、編集、削除、追加を行うことができる。                             |
| Read          | ユーザーはファイルとサブフォルダの内容を閲覧できる。                                                   |
* NTFS基本権限
| 許可                  | 説明|
|-----------------------|--------------------------------------------------------------------------------------------|
| Full Control          | ユーザーは、ファイルとフォルダを追加、編集、移動、削除できるほか、許可されたすべてのフォルダに適用されるNTFS権限を変更することもできる。 |
| Modify             | ユーザーはファイルやフォルダの表示や変更の権限を許可または拒否され、これにはファイルの追加や削除が含まれる。|
| Read & Execute        | ユーザーはファイルの内容の読み取りとプログラムの実行を許可または拒否される。|
| List folder contents   | ユーザーはファイルとサブフォルダの一覧を表示する権限を許可または拒否される。|
| Read                  | ユーザーはファイルの内容を読み取る権限を許可または拒否される。                           |
| Write       | ユーザーには、ファイルへの変更の書き込みとフォルダへの新しいファイルの追加が許可されるか、拒否されるかが決定される。|
| Special Permissions    | さまざまな高度な権限オプションを提供する。                        |
* NTFS の特別なアクセス許可

#### 注意すべき点
* NTFS アクセス許可は、フォルダーとファイルが**ホストされているシステムに適用**される
```
マシンにローカルにログインしているか、RDP 経由でログインしているユーザーは、ファイル システム上の場所に移動するだけで共有フォルダーとファイルにアクセスでき、NTFS アクセス許可のみを考慮する必要
```
* 共有アクセス許可は、フォルダーが** SMB 経由でアクセス**されている場合 (通常はネットワーク上の別のシステムから) に適用

### ② ネットワーク共有の作成
1. フォルダ作成
2. フォルダを右クリックして、「プロパティ」(Proparty)を開いて「共有」(Share)タブを選択し、「詳細な共有」(Advanced Sharing)から設定

![image](https://github.com/user-attachments/assets/17ed554c-e034-410a-bca9-b03684d8e71a)

3. フォルダの「このフォルダーを共有にする」(Share this folder) にチェックし、共有名、任意の人数制限、任意のコメントを設定し、「アクセス許可」(Premissions)を選択する。
![image](https://github.com/user-attachments/assets/b8281a9f-e7b2-499f-a3ed-dcdddb511114)

4. アクセスするユーザやグループのアクセス権を設定し、ok
![image](https://github.com/user-attachments/assets/8a82f8fb-60d0-4986-b03c-a7b63028e967)

### ③ Windows Defender ファイアーウォールによるデフォルトのsmb共有のブロック
* Workgroupの場合(ドメインに参加していないWindows) : 同じWorkgroupに参加していないデバイスからのアクセスは、許可されない。
> あと関係ないけどWorkgroupが同じだったら「SAMデータベース」(LocalのPCにある認証機構)で認証する
* Windowsドメインに参加している場合 : netlogon要求は、AD(Active Direcctory)にやって行われる。ADが許可出せばブロックされない。
### ④ smb共有へのアクセス
* LinuxによるSmb共有へアクセス,共有のマウント
> ```
> ◇ 利用可能な共有を一覧表示
> smbclient -L -U $USER \\$IP (ユーザ認証あり)
> smbclient -N -L \\$IP       (ユーザ認証無し(everyoneを利用))
>
> ◇ 共有へのアクセス
> smbclient -U $user \\$IP\$share  (ユーザ認証あり)
> smbclient -N \\$IP\$share        (ユーザ認証無し(everyoneを利用))
>
> ◇ CIFSユーティリティのインストール
> sudo apt-get install cifs-utils
> 
> ◇ 共有をマウント
> sudo mount -t cifs -o username=$user,password=$pass //$IP/$share $mount-full-path
> ```

* Windowsによるsmb共有へのアクセス、共有マウント
  * エクスプローラーから行く方法(パスをやるところに「\\ホスト名orIP\共有名」で検索かける」)
  ![image](https://github.com/user-attachments/assets/78bd4116-8412-40cf-a9da-256c90d2b7e3)
  * 「Win + R」でファイル名を指定して実行で「\\ホスト名orIP\共有名」を入力
  * コマンドプロンプト(DOS,PowerShell)だと、「\\ホスト名orIP\共有名」に対して、共有されていればファイル操作のコマンドが利用できる
  > ```
  > 例：dir \\%host%\%share%,copy \\%host%\%share%\%file% .\%file-name%
  > ```
  * 「net use」コマンドを利用して共有をマウントしてしよう(自分のログインユーザがアクセス権を持たないときに別のユーザの認証を利用してアクセスできる)
  > ```
  > net use \\%host%\%share% /user:%user% %pass%
  > 以下マウントした共有(\\%host%\%share%)に操作できる
  > ```

### ④ Windowsによるsmb共有の把握、監視
* 「net share」を利用した自分の共有の把握(攻撃のときに、Windowsのマシンに侵入できたら確認したいね)
> ```
> net share
> ```
* 「コンピュータ管理」(Computer Management)から共有を監視
![image](https://github.com/user-attachments/assets/4c8fc318-75e4-4372-8897-8d46ac9d4ad4)
* イベント ビューアーで監視(攻撃者は、マルウェアや攻撃ツールを配送したり、配布するために共有を作るかもな)
* 「net view」を使用した他のコンピュータの共有フォルダの探索(攻撃のときに、Windowsのマシンに侵入できたら、ためしたいね)
> ```
> net view \\%host%
> 共有されているフォルダのリストが表示されるよ
> ```

