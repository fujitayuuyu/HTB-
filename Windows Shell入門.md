# 1 CMD(MS DOS shell)
* cmd.exeのパス：`C:\Windows\System32\cmd.exe`
* helpコマンド：help %cmd% , コマンド /?  (基本、マニュアルを確認すればなんでも行けるからまずマニュアルみろおおお)
* 使えるショートカット


## (1) ナビゲーション
* dir  - ディレクトリ内のファイルを一覧表示
* cd   - 移動(引数なしだと、カレントディレクトリのパスを教えてくれるよ)
* tree - ファイルシステムの内容の一覧表示(設定、プロジェクト ファイルやフォルダー、さらには究極の目標であるパスワードを含むファイルやフォルダーなど、必要な重要な情報を含むファイルやフォルダーを検索するときに非常に便利)
> ```
> tree /F (指定されたパス内のすべてのファイルとフォルダーの一覧を取得する)
> ```

### ① 興味深いファイル
侵入後の権限昇格のために使えるディレクトリだよ
| 名前                     | 場所                           | 説明                                                                                           |
|------------------------|------------------------------|------------------------------------------------------------------------------------------------|
| %SYSTEMROOT%\Temp     | C:\Windows\Temp              | グローバルなディレクトリで、全ユーザーがアクセスできる一時的なシステムファイルを含む。全ユーザーにフルアクセス権が与えられている。低特権ユーザーがファイルをドロップするのに便利。  |
| %TEMP%                 | C:\Users\<user>\AppData\Local\Temp | ユーザー専用の一時ファイルを含むローカルディレクトリ。フォルダの所有者にフルオーナーシップが与えられる。ローカルまたはドメインに参加しているユーザーアカウントを攻撃者が取得した際に便利。  |
| %PUBLIC%               | C:\Users\Public              | インタラクティブログインアカウントがファイルやサブフォルダに対してフルアクセスできる公共アクセス可能なディレクトリ。監視が少ないため、グローバルWindows Tempディレクトリの代替として利用可能。 |
| %ProgramFiles%         | C:\Program Files             | システムにインストールされているすべての64ビットアプリケーションが含まれるフォルダ。ターゲットシステムにインストールされているアプリケーションを確認するのに便利。                  |
| %ProgramFiles(x86)%    | C:\Program Files (x86)      | システムにインストールされているすべての32ビットアプリケーションが含まれるフォルダ。ターゲットシステムにインストールされているアプリケーションを確認するのに便利。                   |
| %HOME%                 | C:\Users\%user%             | ユーザが作業しているところなので、いろいろ置かれている。認証情報等のメモや、そのほか、内部に関する情報が含まれる可能性がある。 |

## (2) ディレクトリとファイル操作
* 大体のやつは、/Aオプションが使えて、ファイル属性を指定できるよ(秘密ファイルとか)
* パイプ、リダイレクションはlinuxと変わらない。
* 連続実行は、「&」で、前の実行の可否に依存するのは「&&」
### ① ディレクトリの作成、削除
* mkdir - ディレクトリ作成
* rd    - ディレクトリ削除(/sオプションでディレクトリの中身も含めて削除できる)

### ② ファイルの表示
* more - ファイルの中身を見れるよ。linuxのlessみたいな感じ。「|」パイプを利用すれば、コマンド実行の結果を見るのも楽だよ(/Sオプションを利用すると結構見やすい)
> ```
> ◇ パイプを利用したやつ
> systeminfo | more  
> ```
* type - シンプルにファイルの中身を一気に表示するよ。「>>」のリダイレクションを利用すれば、ファイルのテキストをまとめるのが楽だよ。
> ```
> ◇ リダイレクションを利用してファイルのテキストをほかのファイルにまとめる
> type passwords.txt >> secrets.txt
> ```

### ③ ファイルの作成、削除
* `echo` - 標準出力を出してくれるやつ(こいつで、リダイレクションしてファイル作れる)
* `del,erase` - ファイル削除、二つあるのは、互換性を保つためあるだけよ

### ④ ファイル、ディレクトリの移動、コピー
* `move` - ファイル、ディレクトリの移動
* `copy` - ファイル、ディレクトリのコピー
* `xcopy`　- copyの拡張(copyより細かいコピーができるよ。ディレクトリごとコピーが/E、属性情報を変えないとかなら/K)
* `robocopy` - xcopyの拡張

## (3) システム情報の収集
![image](https://github.com/user-attachments/assets/0cc0df07-793e-4312-827f-52faf6f471e0)

* システム情報のタイプ
  * 一般システム情報 - 固有のOS情報やhost名、適用されているパッチなど。マシンの役割やOSに起因する脆弱性を調べることができる。
  * ネットワーク情報 - IPアドレスやARPテーブル、hostsの情報、ネットワークの接続状態など。ネットワークのマッピングができ、内部ネットワークを解明できる。
  * ドメイン情報 - ドメインに参加しているか。参加していたら、Domain(AD)等の分析を行う。
  * ユーザ情報 - ユーザ名、ユーザの所属グループ、ユーザの権限など。


※特定のコマンドが他のコマンドよりも厳密に監視および追跡されている場合、情報を収集する方法を 1 つだけ知っていても効率的ではありません。このため、必要な情報を収集し、可能な限り検出を逃れるためには、確立された複数の方法が必要

### ① 一般システム情報の収集
> ```
> systeminfo
> - OS情報、ホスト名、IP アドレス、ドメインに属しているかどうか、インストールされている修正プログラムなど
>
> hostname
> - ホスト名
> ver
> - OSバージョン情報
> 
> ```

### ② ネットワーク情報
> ```
> ipconfig /all
> - ドメイン名、IPアドレス、サブネットマスク、デフォルトゲート、MACアドレス、DHCP設定、DNS設定など
>
> arp /a
> - ARPテーブル(ターゲットがどのホストと接続したかを確認でき、アクセスできる可能性の高いIPがわかる)
>
> type C:\windows\system32\drivers\etc\hosts
> - hostsファイルの情報からレガシーシステム等のドメイン情報などが取得できる
> ```

### ② ユーザ情報
> ```
> ◇ 自身のユーザ情報を取得
> whoami
> - オプション無し  ログインユーザの参加ドメイン、ユーザ名
> - /priv          ログインユーザの権限情報
> - /groups        ログインユーザの所属グループ
> - /all           ログインユーザのSID、参加ドメイン、ユーザ名、所属グループ、権限情報(上にあるやつ全て表示)
> set user (ユーザ関連の環境変数を表示させる)
> - ログインユーザのユーザ名、参加ドメイン、
> 
> set
> - 環境変数の値を列挙
> 
> net share       (現在侵害を受けているユーザーがアクセスできる共有のリストが分かる)
> - 共有情報の列挙
>
> net view
> - 共有リソースの列挙
>
> net start
> - 起動中のサービスを表示
>
> net config server (サーバーサービスの構成情報を確認する)
> - サーバ名、OSバージョン、最大ユーザ数、最大セッション数
>
> net config workstation (ワークステーションサービスの構成情報を確認する)
> - マシン名、ユーザ名、OSバージョン、使用ドメインなどの情報
> 
> ◇ ほかのユーザ情報の取得
> net user
> - オプション無し  ローカルユーザの列挙
> - /domain        参加ドメイン内のユーザの列挙
> - ユーザ名を指定  ユーザのアカウント情報や所属グループ等(ドメインユーザなら/domainをつける必要がある)
> 
> ◇ ほかのグループ情報の取得
> net localgroup   ローカルグループに所属するユーザ一覧取得
> - オプション無し  ローカルグループ名の列挙
> - グループ指定    指定したローカルグループに参加しているユーザ名
>
> net group        特定ドメインのグループに所属するユーザ一覧取得
> - オプション無し  ドメイングループ名を列挙
> - /domain        ドメインを指定する(デフォルト : 自分が参加しているドメイン)
> - グループ指定    指定したドメイングループに参加しているユーザ名
>
> ◇ AD情報の収集
> dsquery
> - Active Directoryに含まれるアカウントの検索
>
> csvde
> - Active Directoryに含まれるアカウント情報取得
> ```

### ④ コマンドによるシステム情報の列挙などのシステム内での情報収集について
これは、限られたリソースの中で、CMDを使用してどのようにアクセスし、アセスメントを継続できるかを簡単に示したものである。 
* このルートは非常にノイズが多く、半端な能力を持つブルーチームにさえいずれは気づかれてしまうことを心に留めておいてください。
* 現状では、私たちは大量のログを書き、複数のホストに痕跡を残していますが、彼らのEDRやNIDSが何を見ることができたかについてはほとんど何もわかりません。

## --コラム-- どのようにすればノイズが少ないのか？
* コマンドからでなく、設定ファイル等の内容を「type」コマンドなどで表示する形ならどうだろうか　⇒　参照できる設定ファイルからシステム情報を読み取る方法
* 利用できるプログラム、サービスを探したいのであれば、`C:\Program Files (x86)`配下のディレクトリを列挙するとか  ⇒  特定のディレクトリの配下のファイル、ディレクトリの列挙によりシステム情報を読み取る方法
* OSやプログラムの更新、サービスやドライバーの使用をファイルのタイムスタンプで推測する。

が、自分的に考えられたよ。
### ① dirによるインストールの列挙、サービスの列挙、ドライバーの列挙(使用されているかどうかは、ファイルタイムスタンプの履歴とかで分かるはず)
| 項目                          | ディレクトリ                                                                                         | コマンド                                      |
|-------------------------------|------------------------------------------------------------------------------------------------------|-----------------------------------------------|
| ** 32ビットアプリケーション** | `C:\Program Files (x86)`                                                                              | `dir "C:\Program Files (x86)" /s`             |
| ** 64ビットアプリケーション** | `C:\Program Files`                                                                                    | `dir "C:\Program Files" /s`                   |
| ** Windowsアプリ (UWP)**      | `C:\Program Files\WindowsApps`                                                                        | `dir "C:\Program Files\WindowsApps" /s`       |
| ** スタートアップ (全ユーザー)**| `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp`                                       | `dir "C:\ProgramData\...\StartUp" /s`         |
| ** スタートアップ (ユーザー)** | `C:\Users\<ユーザー名>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\StartUp`                | `dir "C:\Users\...\StartUp" /s`               |
| ** サービス実行**      | `C:\Windows\System32`                                                                                 | `dir "C:\Windows\System32" /s`                |
| ** インストールされているドライバー**       | `C:\Windows\System32\drivers`                                                                         | `dir "C:\Windows\System32\drivers" /s`        |


### ② ファイルのタイムスタンプからの読取り(例：OSのライセンス情報)
ファイルパス：C:\Windows\System32\license.rtf

#### dirコマンドのタイムスタンプオプション(/T)
/T:C - 作成日時をタイムフィールドに出力  
/T:A - 最終アクセス日時をタイムフィールドに出力  
/T:W - 最終更新日時をタイムフィールドに出力  

1. 最終更新日時  
  indowsのインストール時期: license.rtf ファイルは、Windowsがインストールされたときに作成されるため、最終更新日時がインストールの日付に近い場合、そのOSがインストールされた日を示しています。  
  OSのアップデート: タイムスタンプが最近であれば、Windowsのアップデートやパッチ適用時にファイルが更新された可能性があります。この場合、最新のアップデートに関連する変更があったことを示唆しています。

2. 最終アクセス日時  
  システムの利用状況: 最終アクセス日時が最近であれば、ユーザーがファイルを参照したか、何らかの理由で使用された可能性があります。これにより、ユーザーのアクティビティやシステム管理の状況が推測できるかもしれません。  

3. 作成日時  
  OSの初期設定: この日時は、通常、OSの初期インストール時のタイムスタンプであるため、そのOSがいつ導入されたのかを知る手がかりとなります。  

◇ 推測の限界  
  ファイルが削除されたり再作成された場合: タイムスタンプが更新されることがあります。たとえば、ファイルが削除されて新たに作成された場合、作成日時が変わります。  
  更新の頻度: Windows Updateが定期的に行われるため、ファイルのタイムスタンプが頻繁に更新されることがありますが、その内容の変更は直接的に示されないことがあります。  

### ③ まとめ
なんかやってることが、デジタルフォレンジックのファイルシステムの解析に似ていた。
* ファイルシステムの構造を知っていると、コマンドに頼らなくてもある程度内部偵察や脆弱性の探索ができそうだと感じた。
* フォレンジックの技術が攻撃者にも利用できると感じた。

## (4) ファイルとディレクトリの検索
コンフィグファイルや興味深い認証に関連するファイル、企業の機密ファイルとかを探すときに使える。

1. ファイル検索 - Where 
> ```
> ◇ コマンドのファイルパスの検索
> 	where cmd.exe
>
> ◇ 指定したフォルダ以下に対するファイル名の検索(再帰的な検索)
> 	where /R %dir% %filename%
>
> ※ワイルドカードを利用できる
>
> ◇ 再帰的検索とワイルドカードを利用した。txtファイルの検索
> 	where /Users/ *.txt
> ```

2. 文字列検索 - find,findstr (「findstr」がlinuxでいうgrepみたいなやつになっているからそっち使った方がいい,ちな正規表現使える)

3. 比較 - comp,fc (linuxのdiffとかわらん)

4. 整列、一意化 - sort (/uniqueオプションで重複を消せる)
