# 1 ネットワーク解析の心構え
## (1) ネットワークトラフィックの利用例
### ◇ リアルタイムでのトラフィック収集
ネットワークのトラフィックをリアルタイムで監視し、脅威を検知できる

### ◇ 通常の通信基準を設定
通常の通信パターンを基準として設定し、異常な活動を特定します。

#### より具体的な例
ネットワークでまったく（またはめったに）使用しないポートで多くのSYNパケットが検出した場合は、ポートスキャンとして検知させるみたいな。

### ◇ 不審なトラフィックの解析
非標準ポートの通信や怪しいホスト、プロトコルの問題を分析します。

### ◇ マルウェア検出
ランサムウェアやエクスプロイトなどの悪意のある通信を検出します。

### ◇ インシデント調査や脅威ハンティング
過去のインシデント調査や脅威探索に活用されます。

## (2)  必要な知識
オーム社の「マスタリングTCP/IP入門」と、「マスタリングTCP/IP(情報セキュリティ編)」を網羅すればいいじゃない

## (3) トラフィック分析用のツール
| **ツール**               | **説明**                                                                                                                                           |
|------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| **tcpdump**             | ネットワークインターフェイスやキャプチャファイルからネットワークトラフィックをキャプチャして解析するコマンドラインツール。                                                   |
| **TShark**              | Wiresharkのコマンドライン版で、ネットワークからパケットをキャプチャして解析する。                                                                     |
| **Wireshark**           | グラフィカルなネットワークトラフィックアナライザー。トラフィックを詳細に調査し、プロトコルやアプリケーションの挙動を解析する。                                                    |
| **NGrep**               | 正規表現とBPF構文を使ってネットワークトラフィックをパターンマッチングするツール。主にHTTPやFTPなどのトラフィックデバッグに使用。                                         |
| **tcpick**              | TCPストリームの追跡と再構成に特化したパケットスニファー。                                                                                           |
| **Network Taps**        | ネットワークトラフィックのコピーを取得し、別の場所で分析するために使用されるデバイス。                                                             |
| **Networking Span Ports** | スパンポートは、ネットワークデバイスのフレームをコピーし、収集ポイントに送信する機能。                                                             |
| **Elastic Stack**       | データを収集し、視覚化と分析を行うツール群。                                                                                                       |
| **SIEM (Splunkなど)**   | セキュリティイベントやデータの視覚化、アラート、フォレンジック分析などを行う統合的な監視システム。                                                  |

## (4) ネットワークトラフィック分析のワークフロー
### ◇ ワークフローの図
![image](https://github.com/user-attachments/assets/7dcb42cf-3c75-4658-b9f4-023c1cd80083)

### ◇ ワークフロー
1. トラフィックの取り込み
2. フィルタリングでノイズを減らす
3. 分析と探索
4. 検出と警告
5. 修正と監視

# 2 分析の仕方
一つの例を用いて分析手法のつながりを示す
## (1) 記述的分析
### ◇ 概要
ワークフローを使用して、問題、探しているもの、それをいつ、どこで見つけるかを決定するという手法

### ◇ 手順例
1. 何が起きた
  - 侵害の疑い? ネットワークの問題?
2. スコープと目的を明確にする
  - ターゲット: bad.example.com から悪意のあるファイルをダウンロードする可能性のある複数のホスト
  - 日時: 過去 48 時間以内 + 今から 2 時間以内。
  - サポート情報: ファイル名/タイプ 'superbad.exe' 'new-crypto-miner.exe'
3. 影響範囲(ネット/ホスト/プロトコル)を明確にする
  - 範囲: 192.168.100.0/24 ネットワーク、使用されるプロトコルは HTTP と FTP 

## (2) 診断分析
### ◇ 概要
* 状態の原因、影響、相互作用を明らかにする。相関関係と解釈を通じて得られる洞察を提供する
* 既知の正常なデータをすべて消去し、時間をかけて残っているものを検査して理解することで、それが問題の原因であるかどうかを判断できる。

### ◇ 手順例
4. ネットワークトラフィックの取得
 - 192.168.100.0/24 ネットワークにアクセスできるリンクに接続し、ライブ トラフィックをキャプチャして、転送中の実行可能ファイルの 1 つを取得してみる。  
管理者が SIEM から PCAP および/またはネットフロー データを取得して履歴データを取得できるかどうかを確認する。
5. 必要なネットワーク・トラフィック・コンポーネントの特定（フィルタリング）
 - トラフィックを取得したら、この調査に含める必要のないパケットをフィルタリングします。  
つまり、共通のベースラインに一致するトラフィックをすべて除外し、調査の範囲に関連するものはすべて保持する。  
たとえば、サブネットからの HTTP および FTP、疑わしい実行可能ファイルに対する GET 要求を転送または含むものなどです。
6. キャプチャされたネットワークトラフィックの分析をする。
 - ノイズをフィルターで除去したら、ターゲットを探し出す段階。
 - 転送されたファイルを見つけて再構築するなど、フィルタリングを行う
 -  GET リクエストを`http.request.method == "GET"`といったようににフィルタリングできます
 -  これにより、誰がファイルを取得したか、また、同じプロトコルでネットワーク内部で行われたその他の転送が誰であるかがわかる。

## (3) 予測分析
### ◇ 概要
* 過去のデータと現在のデータを評価することで、将来の確率の予測モデルを作成。
* 記述分析と診断分析の結果に基づいて、このデータ分析方法により、傾向を特定し、期待値からの逸脱を早期に検出し、将来の発生を可能な限り正確に予測することが可能

### ◇ 手順例
7. 発見された結果のメモ書きとマインドマップ作成
  - 調査中に行うすべてのこと、見るもの、見つけたものすべてに注釈をつけることは非常に重要です。以下の点を含め、十分なメモを取ろう。
    - トラフィックをキャプチャした期間。
    - ネットワーク内の疑わしいホスト。
    - 問題のファイルを含む会話。(タイムスタンプとパケット番号を含む)
8. レポート作成、分析のまとめ（何を見つけたか？）
  - 最後に、上司が影響を受けたホストを隔離するか、より重要なインシデント対応を実行するかを決定できるように、関連する詳細を説明して、発見した内容を要約する。
  - 私たちの分析は意思決定に影響を与えるため、できるだけ明確かつ簡潔にすることが重要。

## (4) 規範的分析
### ◇ 概要
これまでのワークフローの結果を使用し、将来の問題を排除または防止したり、特定のアクティビティやプロセスをトリガーしたりするために、どのようなアクションを実行するかを絞り込む。

## (5) 効果的な分析に重要な要素
* 環境を知っていること
* トラフィックをキャプチャするホストの配置
* 粘り強さ(忍耐力)

# 3 TCP dumpの使い方
