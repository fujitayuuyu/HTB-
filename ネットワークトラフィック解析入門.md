# 1 ネットワーク解析の心構え
## (1) ネットワークトラフィックの利用例
### ◇ リアルタイムでのトラフィック収集
ネットワークのトラフィックをリアルタイムで監視し、脅威を検知できる

### ◇ 通常の通信基準を設定
通常の通信パターンを基準として設定し、異常な活動を特定します。

#### より具体的な例
ネットワークでまったく（またはめったに）使用しないポートで多くのSYNパケットが検出した場合は、ポートスキャンとして検知させるみたいな。

### ◇ 不審なトラフィックの解析
非標準ポートの通信や怪しいホスト、プロトコルの問題を分析します。

### ◇ マルウェア検出
ランサムウェアやエクスプロイトなどの悪意のある通信を検出します。

### ◇ インシデント調査や脅威ハンティング
過去のインシデント調査や脅威探索に活用されます。

## (2)  必要な知識
オーム社の「マスタリングTCP/IP入門」と、「マスタリングTCP/IP(情報セキュリティ編)」を網羅すればいいじゃない

## (3) トラフィック分析用のツール
| **ツール**               | **説明**                                                                                                                                           |
|------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| **tcpdump**             | ネットワークインターフェイスやキャプチャファイルからネットワークトラフィックをキャプチャして解析するコマンドラインツール。                                                   |
| **TShark**              | Wiresharkのコマンドライン版で、ネットワークからパケットをキャプチャして解析する。                                                                     |
| **Wireshark**           | グラフィカルなネットワークトラフィックアナライザー。トラフィックを詳細に調査し、プロトコルやアプリケーションの挙動を解析する。                                                    |
| **NGrep**               | 正規表現とBPF構文を使ってネットワークトラフィックをパターンマッチングするツール。主にHTTPやFTPなどのトラフィックデバッグに使用。                                         |
| **tcpick**              | TCPストリームの追跡と再構成に特化したパケットスニファー。                                                                                           |
| **Network Taps**        | ネットワークトラフィックのコピーを取得し、別の場所で分析するために使用されるデバイス。                                                             |
| **Networking Span Ports** | スパンポートは、ネットワークデバイスのフレームをコピーし、収集ポイントに送信する機能。                                                             |
| **Elastic Stack**       | データを収集し、視覚化と分析を行うツール群。                                                                                                       |
| **SIEM (Splunkなど)**   | セキュリティイベントやデータの視覚化、アラート、フォレンジック分析などを行う統合的な監視システム。                                                  |

## (4) ネットワークトラフィック分析のワークフロー
### ◇ ワークフローの図
![image](https://github.com/user-attachments/assets/7dcb42cf-3c75-4658-b9f4-023c1cd80083)

### ◇ ワークフロー
1. トラフィックの取り込み
2. フィルタリングでノイズを減らす
3. 分析と探索
4. 検出と警告
5. 修正と監視

# 2 分析の仕方
一つの例を用いて分析手法のつながりを示す
## (1) 記述的分析
### ◇ 概要
ワークフローを使用して、問題、探しているもの、それをいつ、どこで見つけるかを決定するという手法

### ◇ 手順例
1. 何が起きた
  - 侵害の疑い? ネットワークの問題?
2. スコープと目的を明確にする
  - ターゲット: bad.example.com から悪意のあるファイルをダウンロードする可能性のある複数のホスト
  - 日時: 過去 48 時間以内 + 今から 2 時間以内。
  - サポート情報: ファイル名/タイプ 'superbad.exe' 'new-crypto-miner.exe'
3. 影響範囲(ネット/ホスト/プロトコル)を明確にする
  - 範囲: 192.168.100.0/24 ネットワーク、使用されるプロトコルは HTTP と FTP 

## (2) 診断分析
### ◇ 概要
* 状態の原因、影響、相互作用を明らかにする。相関関係と解釈を通じて得られる洞察を提供する
* 既知の正常なデータをすべて消去し、時間をかけて残っているものを検査して理解することで、それが問題の原因であるかどうかを判断できる。

### ◇ 手順例
4. ネットワークトラフィックの取得
 - 192.168.100.0/24 ネットワークにアクセスできるリンクに接続し、ライブ トラフィックをキャプチャして、転送中の実行可能ファイルの 1 つを取得してみる。  
管理者が SIEM から PCAP および/またはネットフロー データを取得して履歴データを取得できるかどうかを確認する。
5. 必要なネットワーク・トラフィック・コンポーネントの特定（フィルタリング）
 - トラフィックを取得したら、この調査に含める必要のないパケットをフィルタリングします。  
つまり、共通のベースラインに一致するトラフィックをすべて除外し、調査の範囲に関連するものはすべて保持する。  
たとえば、サブネットからの HTTP および FTP、疑わしい実行可能ファイルに対する GET 要求を転送または含むものなどです。
6. キャプチャされたネットワークトラフィックの分析をする。
 - ノイズをフィルターで除去したら、ターゲットを探し出す段階。
 - 転送されたファイルを見つけて再構築するなど、フィルタリングを行う
 -  GET リクエストを`http.request.method == "GET"`といったようににフィルタリングできます
 -  これにより、誰がファイルを取得したか、また、同じプロトコルでネットワーク内部で行われたその他の転送が誰であるかがわかる。

## (3) 予測分析
### ◇ 概要
* 過去のデータと現在のデータを評価することで、将来の確率の予測モデルを作成。
* 記述分析と診断分析の結果に基づいて、このデータ分析方法により、傾向を特定し、期待値からの逸脱を早期に検出し、将来の発生を可能な限り正確に予測することが可能

### ◇ 手順例
7. 発見された結果のメモ書きとマインドマップ作成
  - 調査中に行うすべてのこと、見るもの、見つけたものすべてに注釈をつけることは非常に重要です。以下の点を含め、十分なメモを取ろう。
    - トラフィックをキャプチャした期間。
    - ネットワーク内の疑わしいホスト。
    - 問題のファイルを含む会話。(タイムスタンプとパケット番号を含む)
8. レポート作成、分析のまとめ（何を見つけたか？）
  - 最後に、上司が影響を受けたホストを隔離するか、より重要なインシデント対応を実行するかを決定できるように、関連する詳細を説明して、発見した内容を要約する。
  - 私たちの分析は意思決定に影響を与えるため、できるだけ明確かつ簡潔にすることが重要。

## (4) 規範的分析
### ◇ 概要
これまでのワークフローの結果を使用し、将来の問題を排除または防止したり、特定のアクティビティやプロセスをトリガーしたりするために、どのようなアクションを実行するかを絞り込む。

## (5) 効果的な分析に重要な要素
* 環境を知っていること
* トラフィックをキャプチャするホストの配置
* 粘り強さ(忍耐力)

# 3 TCP dumpの使い方
## (1) Tcp dumpの基礎
### ① Tcpdumpについて
* ファイルまたはネットワーク インターフェイスからデータ フレームを直接キャプチャして解釈できるコマンド ライン パケット スニファ。
* WindowsっだとWinDumpがあるよ
* ADなりすましによるハッシュの盗聴などにも利用できる。
### ② Tcpdumpのオプション
| **Switch Command** | **Result**                                                                                           |
|--------------------|------------------------------------------------------------------------------------------------------|
| **D**              | 使用可能なキャプチャインターフェイスを表示します。                                                                            |
| **i**              | キャプチャするインターフェイスを選択します。例: `-i eth0`                                                                   |
| **n**              | ホスト名を解決しません。                                                                                     |
| **nn**             | ホスト名や既知のポート番号を解決しません。                                                                             |
| **e**              | イーサネットヘッダーと上位層データをキャプチャします。                                                                          |
| **X**              | パケットの内容を16進数とASCIIで表示します。                                                                             |
| **XX**             | `X` と同様ですが、イーサネットヘッダーも指定します。 (`Xe` を使用した場合と同様)                                                  |
| **v, vv, vvv**     | 出力の詳細度を増やします。                                                                                       |
| **c**              | 特定のパケット数をキャプチャし、終了します。                                                                             |
| **s**              | キャプチャするパケットの量を定義します。                                                                                 |
| **S**              | キャプチャ表示で相対シーケンス番号を絶対シーケンス番号に変更します。 (`101` の代わりに `13248765839`)                                   |
| **q**              | プロトコル情報を少なく表示します。                                                                                  |
| **r file.pcap**    | ファイルからデータを読み取ります。                                                                                   |
| **w file.pcap**    | ファイルにデータを書き込みます。                                                                                     |
| **-l**             | grepなどの別の関数にパイプ出力できる。 |
詳しくは、manで見ろ

### ② Tcpdumpによるトラフィックのキャプチャ
#### ◇ 利用可能なインターフェースの一覧表示
```
sudo tcpdump -D
```
#### ◇ キャプチャするインターフェースの選択
```
sudo tcpdump -i eth0
```
#### ◇ 名前解決を無効にする
```
sudo tcpdump -i eth0 -nn
```
#### ◇ ASCII及び16進出力を含める
```
sudo tcpdump -i eth0 -X
```
#### ◇ スイッチの組み合わせ
```
sudo tcpdump -i eth0 -nnvXX
```
### ④ Tcpdump によるファイル入出力
#### ◇ PCAP出力をファイルに保存する
```
sudo tcpdump -i eth0 -w ~/output.pcap
```
#### ◇ ファイルからの出力の読取り
```
 sudo tcpdump -r ~/output.pcap
```

### ④ Tcpdumpによるパケットフィルタリング
#### ◇ フィルタリングのやつ
| **Filter**           | **Result**                                                                                                          |
|----------------------|---------------------------------------------------------------------------------------------------------------------|
| **host**             | 指定されたホストに関連するすべての双方向トラフィックを表示します。 |
| **src / dest**       | `src` と `dest` は修飾子で、ソースまたは宛先ホストやポートを指定するために使用します。 |
| **net**              | 指定されたネットワークから送信または宛先となるすべてのトラフィックを表示します。`/` 表記を使用します。 |
| **proto**            | 特定のプロトコル (例: Ether, TCP, UDP, ICMP) のトラフィックをフィルタリングします。 |
| **port**             | 双方向で、指定されたポートがソースまたは宛先となるすべてのトラフィックを表示します。 |
| **portrange**        | ポートの範囲を指定して、その範囲内のトラフィックを表示します。(例: `0-1024`) |
| **less / greater < >** | 特定のサイズのパケットやプロトコルオプションをフィルタリングするために使用します。 |
| **and / &&**         | 2つの異なるフィルターを連結します。例: `src host AND port`。                                                                |
| **or**               | 2つの条件のいずれかを満たすトラフィックを表示します。両方を満たす必要はありません。ややトリッキーです。                                |
| **not**              | `not` は修飾子で、特定のプロトコルや条件を除外するために使用します。例: `not UDP`。                                                |

#### ◇ 利用できる演算子
| **Operator**     | **Description**                                                                 |
|------------------|---------------------------------------------------------------------------------|
| **and / &&**     | 両方の条件が満たされる場合に一致します。例: `src host 192.168.1.1 && port 80`       |
| **or / ||**      | どちらかの条件が満たされる場合に一致します。例: `src host 192.168.1.1 || port 80`    |
| **not / !**      | 条件に一致しないものをフィルタリングします。例: `not tcp`                             |
| **<**            | 指定されたサイズ未満のパケットをフィルタリングします。例: `less 64`                   |
| **>**            | 指定されたサイズを超えるパケットをフィルタリングします。例: `greater 64`              |
| **=**            | 正確に一致する条件をフィルタリングします。例: `port = 80`                            |
| **& (bitwise and)** | ビットごとのAND演算を行います。例: `tcp[13] & 0x02 != 0`（SYNフラグをフィルタ）    |
| **| (bitwise or)**  | ビットごとのOR演算を行います。例: `tcp[13] | 0x12 == 0x12`（SYNとACKフラグをフィルタ）|
| **>> (right shift)**| 右にビットシフトします。例: `ip[0] >> 2`                                          |
| **<< (left shift)** | 左にビットシフトします。例: `ip[0] << 2`                                          |

#### ◇ ip,tcp等の中身で比較する
一応、ipやtcpのオプションやヘッダー、データには、`[x]`によってアクセスできる。また、特定の例えば、TCPのフラグなら  
`tcp[tcpflags]`といったようにできる。また、`tcp[12:1]`といったようにデータを指定できる。  
そのため以下のようにHTTPのPOSTメソットのみにフィルタできる
```
sudo tcpdump -i eth0 -Z root -C 1 -A 'tcp dst port 80 and (tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x504f5354)' -w post_data
```

#### ◇ TCPのフラグの指定(例：SYN-ACKのパケットを出力する)
```
'tcp[tcpflags] == (tcp-syn|tcp-ack)'
```

# 4 Wireshark 
## (1) TShark(in linux)
### ◇ TSharkのオプション
| **Switch Command** | **説明**                                                                                          |
|--------------------|---------------------------------------------------------------------------------------------------|
| **D**              | 利用可能なインターフェースを表示して終了します。                                                 |
| **L**              | キャプチャ可能なリンク層のメディアを一覧表示して終了します。（例：Ethernet）                     |
| **i**              | キャプチャするインターフェースを選択します。（例：`-i eth0`）                                     |
| **f**              | libpcap 構文でのパケットフィルター。キャプチャ中に使用されます。                                  |
| **c**              | 指定した数のパケットをキャプチャし、プログラムを終了します。終了条件を定義します。               |
| **a**              | 自動停止の条件を定義します。時間、ファイルサイズ、パケット数に基づいて設定できます。              |
| **r (pcap-file)**  | ファイルから読み込みます（例：保存したpcapファイルからのキャプチャ）。                           |
| **W (pcap-file)**  | pcapng形式でファイルに書き込みます。                                                              |
| **P**              | ファイルに書き込みながらパケットの概要を表示します（`-W` と併用）。                              |
| **x**              | キャプチャに16進数とASCIIの出力を追加します。                                                     |
| **h**              | ヘルプメニューを表示します。                                                                      |

詳しいことは、manよめ

## (2) WireShark(GUI)
### ◇ キャプチャフィルター(キャプチャするパケットは、必要なものだけでいい)
| **Capture Filter**                   | **結果**                                                                                              |
|--------------------------------------|-------------------------------------------------------------------------------------------------------|
| **host x.x.x.x**                     | 特定のホストに関連するトラフィックのみをキャプチャします。                                             |
| **net x.x.x.x/24**                   | 特定のネットワーク宛またはそのネットワークからのトラフィックをキャプチャします（スラッシュ表記でマスクを指定）。|
| **src/dst net x.x.x.x/24**           | 指定されたネットワークからのトラフィック、または指定されたネットワーク宛のトラフィックのみをキャプチャします。|
| **port #**                           | 指定されたポート以外のすべてのトラフィックをフィルターします。                                         |
| **not port #**                       | 指定されたポート以外のすべてのトラフィックをキャプチャします。                                         |
| **port # and #**                     | 指定したポートをANDで結合してキャプチャします。                                                        |
| **portrange x-x**                    | 指定された範囲内のポートからのトラフィックのみをキャプチャします。                                     |
| **ip / ether / tcp**                 | 指定されたプロトコルヘッダ（IP、Ethernet、TCP）に基づくトラフィックのみをキャプチャします。             |
| **broadcast / multicast / unicast**  | 特定の種類のトラフィック（一対一、一対多、全員宛）をキャプチャします。                                 |

### ◇ 組み込みのキャプチャフィルターの確認
Wireshark ウィンドウの上部にある「キャプチャ」タブをクリックし、ドロップダウンから「キャプチャ フィルター」を選択する。

![image](https://github.com/user-attachments/assets/dde14aff-da75-49e5-addb-a249a192d338)
ここから、既存のフィルターを変更したり、独自のフィルターを追加したりできる。
### ◇ 表示フィルター
| **Display Filter**                  | **結果**                                                                                                   |
|-------------------------------------|------------------------------------------------------------------------------------------------------------|
| **ip.addr == x.x.x.x**              | 特定のホストに関連するトラフィックのみを表示します。これは OR ステートメントです。                             |
| **ip.addr == x.x.x.x/24**           | 特定のネットワークに関連するトラフィックを表示します。これは OR ステートメントです。                             |
| **ip.src/dst == x.x.x.x**           | 特定のホスト宛、またはそのホストからのトラフィックを表示します。                                              |
| **dns / tcp / ftp / arp / ip**      | 特定のプロトコル (DNS、TCP、FTP、ARP、IP など) に基づいてトラフィックをフィルタリングします。                      |
| **tcp.port == x**                   | 特定の TCP ポートに基づいてフィルタリングします。                                                            |
| **tcp.port / udp.port != x**        | 指定されたポート以外のすべてのトラフィックを表示します。                                                      |
| **and / or / not**                  | AND は結合、OR は2つのオプションのいずれかを検索、NOT は指定した入力オプションを除外します。                   |
| **frame.time >= "YYYY-MM-DD HH:MM:SS"** | 指定した時間以降のトラフィックをフィルタリングします。                                                        |
| **frame.time <= "YYYY-MM-DD HH:MM:SS"** | 指定した時間以前のトラフィックをフィルタリングします。                                                        |
| **frame.time >= "YYYY-MM-DD HH:MM:SS" and frame.time <= "YYYY-MM-DD HH:MM:SS"** | 指定した時間範囲内のトラフィックをフィルタリングします。  |
| **frame.time_delta > x**            | パケット間の時間差が `x` 秒以上のトラフィックを表示します。                                                    |
| **tcp.analysis.acks_frame == x**    | 指定した ACK 応答が確認できるフレームを表示します。                                                           |
| **tcp.seq == x**                    | 特定の TCP シーケンス番号のパケットを表示します。                                                             |
| **frame.len >= x**                  | パケットの長さが `x` バイト以上のトラフィックをフィルタリングします。                                           |
| **frame.len <= x**                  | パケットの長さが `x` バイト以下のトラフィックをフィルタリングします。                                           |
| **tcp.window_size > x**             | TCP ウィンドウサイズが `x` バイト以上のパケットをフィルタリングします。                                         |

## (3) Wiresharkの高度な使用法
### ① 使えるプラグイン
#### ◇ 統計タグ
環境内で最も多く会話を行っているものから特定の会話、さらには IP とプロトコル別の内訳まで、あらゆる情報を表示できる。

#### ◇ 分析タブ
TCP ストリームの追跡、通信タイプのフィルタリング、新しいパケット フィルタの準備、Wireshark がトラフィックに関して生成する専門的な情報の調査などを実行できるプラグインを利用できる。

#### ◇ TCPストリームの追跡
* TCP パケットをつなぎ合わせて、ストリーム全体を読み取り可能な形式で再作成できる機能  
* TCPのストリームだけじゃなく、上位のhttpなどのアプリケーションに絞ったストリームも追跡できる。　  
* 機能を利用するために
  1. 再作成したいストリームのパケットを右クリック
  2. 「追跡」を選択 ⇒ 「TCPストリーム」
  3. すると、ストリームがつなぎ合わさった新しいウィンドウが開く
![image](https://github.com/user-attachments/assets/d36fff7c-334b-4268-a73e-d08422f0919f)

#### ◇ キャプチャからデータやファイルを抽出
* ストリームからさまざまなタイプのデータを復元できる。
* 会話全体をキャプチャする必要がある。
* ストリームからファイルの抽出する方法
  1. キャプチャしてたら、キャプチャを止める
  2. 「ファイル」⇒ 「オブジェクトをエクスポート」⇒ 抽出元のプロトコルの形式を選択
  3. あとは、そのなかのファイルの一つを検索して抽出できる
![image](https://github.com/user-attachments/assets/1460488f-f71b-4710-a323-e7b9f0b3c280)
