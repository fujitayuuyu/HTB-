# linuxについて
## linuxの基本的な原則
| 原理                                           | 説明                                                                                   |
|------------------------------------------------|----------------------------------------------------------------------------------------|
| Everything is a file                           | Linux オペレーティング システム上で実行されるさまざまなサービスのすべての構成ファイルは、1 つ以上のテキスト ファイルに保存される。 |
| Small, single-purpose programs                 | Linux には、連携して動作できるさまざまなツールが用意されている。                              |
| Ability to chain programs together to perform complex tasks | さまざまなツールを統合および組み合わせることで、特定のデータ結果の処理やフィルタリングなど、多くの大規模で複雑なタスクを実行できるようになる。 |
| Avoid captive user interfaces                   | Linux は主にシェル (またはターミナル) で動作するように設計されており、ユーザーはオペレーティング システムをより細かく制御できる。 |
| Configuration data stored in a text file       | このようなファイルの例としては/etc/passwd、システムに登録されているすべてのユーザーを保存するファイルがある。            |

このような原則のおかげで、Windowsよりかは、シンプルなOSになってるよ
Windowsは、分けわからんプロセス多すぎ( ´∀｀ )

## 基本的なディレクトリ構成
| パス     | 説明                                                                                                                 |
|----------|----------------------------------------------------------------------------------------------------------------------|
| /        | 最上位ディレクトリはルート ファイル システムであり、他のファイル システムがマウントされる前にオペレーティング システムを起動するために必要なすべてのファイルと、他のファイル システムの起動に必要なファイルが含まれています。起動後、他のすべてのファイル システムは、ルートのサブディレクトリとして標準のマウント ポイントにマウントされます。 |
| /bin     | 必須のコマンドバイナリが含まれています。                                                                               |
| /boot    | 静的ブートローダ、カーネル実行可能ファイル、および Linux OS の起動に必要なファイルで構成されます。                              |
| /dev     | システムに接続されているすべてのハードウェア デバイスへのアクセスを容易にするデバイス ファイルが含まれています。                   |
| /etc     | ローカル システム構成ファイル。インストールされたアプリケーションの構成ファイルもここに保存される場合があります。                 |
| /home    | システム上の各ユーザーには、ここに保存用のサブディレクトリがあります。                                               |
| /lib     | システムの起動に必要な共有ライブラリ ファイル。                                                                       |
| /media   | USB ドライブなどの外部リムーバブル メディア デバイスはここにマウントされます。                                          |
| /mnt     | 通常のファイルシステムの一時マウント ポイント。                                                                       |
| /opt     | サードパーティツールなどのオプションのファイルをここに保存できます。                                                 |
| /root    | ルート ユーザーのホーム ディレクトリ。                                                                               |
| /sbin    | このディレクトリには、システム管理に使用される実行可能ファイル (バイナリ システム ファイル) が含まれています。               |
| /tmp     | オペレーティング システムと多くのプログラムは、このディレクトリを使用して一時ファイルを保存します。このディレクトリは通常、システムの起動時にクリアされ、他の場合には警告なしに削除されることがあります。 |
| /usr     | 実行可能ファイル、ライブラリ、man ファイルなどが含まれます。                                                         |
| /var     | このディレクトリには、ログ ファイル、電子メールの受信トレイ、Web アプリケーション関連ファイル、cron ファイルなどの可変データ ファイルが含まれています。 |

### 個人的にあまり興味深くないディレクトリ
* /sbin ⇒　基本的な構成は、あまり変わらないし、ほとんどのコマンドはbinに入っているから、ユーザが持ってくるコマンドは、基本binとかusrなどに入っているイメージだから。
* /boot ⇒　起動時の攻撃だったり、カーネルをいじってどうチャラできそうだけど、正直、そこらへんは、バージョン情報から攻撃できるかどうかわかることが多いからあんまり見る必要もないと思う。
* /lib  ⇒　起動時に必要なものなだけで、findコマンドを利用したときは、ノイズにしかならないイメージがあるから。(正直、除外して検索したほうがいいと思う)

### 興味深いディレクトリ
* /bin ⇒　利用できそうな武器がわかる
* /etc ⇒　ネットワークの情報、認証情報、そのほかサービス用の設定情報が置いてある！！(クローンタブの設定ファイルとか、php、webサービス、dns等いろいろ)
* /home ⇒　ユーザが利用するところなので、いろいろ認証情報とかメモとか、個人の趣味のものとかいろいろあるし、作業で作成してるものなどが基本的にある！！また、ユーザが利用しているサービスのキーや実行ログ、セッションキー、profile等が置かれる！！例えば、ユーザのホームディレクトリの配下に.sshディレクトリや、.mysqlなどのそのクライアントが利用できると思われるサービスがわかったり、アクセスキー(今回ならsshのrsa_idなど)が置かれたりする。
* /dev ⇒　通信に使えるものだったり(/dev/tcp)、出力を捨てるためのごみ箱(/dev/null)、
* /var ⇒　logとか、wwwディレクトリがあり、Webのサーバを改ざんしたりできる！！
* /tmp ⇒　プログラムやサービスが利用している一時的なデータやキャッシュなどが置いてある。また、ADに参加してるものだとkerberosのチケットなどが置かれていることがあったりする。
* /usr ⇒　追加で入れられたコマンドだったり、そのコマンド用のライブラリ、がある！！また、kaliとかだと、/usr/share配下のwordlistディレクトリとか各ツールのフォルダは、よく使うよ。あと、wwwの代わりにこのディレクトリ配下にWebを構成していたり、ローカルの設定が入っていたりするよ。
* /proc ⇒ メモリの中に作られるファイルシステムだよ。メモリ、CPU、マウントされたファイルシステムに関する情報やカーネルに関する情報がいろいろあるよ！！

興味深いファイルの一覧はこれ　⇒　https://vk9-sec.com/linux-interesting-files/
#### すべての実行できるコマンドを見たいとき
PATHの環境変数でどこのディレクトリのパスをコマンド実行時見に行くか確認しよう！！
> `echo $PATH`
または、
> `env`

* 実行可能形式を探したいのであれば、
> `find / -perm -u=x -type f`

## シェルについて
### シェルの種類
Bash(Bourne-Again Shell) 以外にも、 Tcsh/Csh、Ksh、Zsh、Fishそしてshがある！！！

ちなみに、shは「Bourne Shell」と言われることがあるが、とっくの昔のことで、最近あるshは、FreeBSD sh や NetBSD sh で、それは、Bourne シェルのクローンとして開発されたashをベースとしたシェルだけど、FreeBSD sh や NetBSD sh は Bourne シェルでも ash でもないらしい。

### ちょこっとコラム　history(コマンドログが残るせるか？)
ほとんどのシェルにhistory機能は、あるけど環境変数のHISTSIZEを0にすると記録されない。また、権限があれば削除できてしまう(基本的に.bash_historyの権限は600)。あと、shとかだと、コマンドの始めにスペースを置くとhistoryに記録されない。
逆に言えば、bashとかで、環境変数を削除されないようにして、ファイルの権限を追記のみにすれば、管理者権限に昇格されなければ、実行したコマンドがわかる。(時刻は、わからんけどね( ´∀｀ )、設定で時刻表示できるかもだけど）

他にも、問題はあるね！！　bashとかでも、ログイン中に、shとかを実行できたしまったら、shの実行以降、shとの対話の内容で実行されたコマンドは、bashには残らない！！
#### どーしてもhistory機能でコマンドログを削除されないようにしたい場合
##### 制限付きシェル(rbash等)を利用させる方法
以下の機能が制限される(利用不可になる)
* ディレクトリーの変更 (cd コマンドによる)
* PATH 変数または SHELL 変数の値の設定
* スラッシュ (/) が含まれているパス名またはコマンド名の指定
* 出力のリダイレクト

しかしながら、あんまりにも制限されるので、ユーザ的には、うれしくない
##### いろいろやって削除されないようにする方法
* 実行できるそして実行するシェルをbashのみにする！！(shを使えないようにする)
* ファイルの権限を追記のみにする(管理者権限でやるね)
> `chattr +a .bash_history`(追記権限のみの付与の方法)
. `lsattr .bash_history `(設定状態の確認方法)
※こいつの問題点としては、ヒストリーが書き込み上限を超えても書きまくるから、多くなったら、管理者権限で`chattr -a .bash_history`してから消さないといけない。
あと、環境変数を制限する方法が、制限付きシェル以外見つからなかったのであきらめて

#### まとめ
セキュリティソフトやほかのサービスでコマンドログを残したほうがいい

# シェル
## プロンプト
入力受付時に表示されるあれね！！

bashとかだと、デフォルトでは、ユーザー、ホスト名、現在の作業ディレクトリなどの情報が含まれています。これは、システムが入力を待つ準備ができていることを示す、ターミナル画面に表示される文字列だね。

### プロンプトの編集
シェルの設定ファイル.bashrc (Bashシェルの場合) 内で特殊文字と変数を使用してカスタマイズできるよ！！
PS1とかいう環境変数に入れるかんじだよ!!

#### カスタマイズに使えるやーつ
| 特殊文字      | 説明                         |
|---------------|------------------------------|
| \d            | 日付 (2月6日月曜日)         |
| \D{%Y-%m-%d} | 日付 (YYYY-MM-DD)           |
| \H            | 完全なホスト名               |
| \j            | シェルによって管理されるジョブの数 |
| \n            | 改行                         |
| \r            | キャリッジリターン           |
| \s            | シェルの名前                 |
| \t            | 現在の時刻 24 時間 (HH:MM:SS) |
| \T            | 現在の時刻 12 時間 (HH:MM:SS) |
| \@            | 現在の時刻                   |
| \u            | 現在のユーザー名             |
| \w            | 現在の作業ディレクトリのフルパス |

## ヘルプの取得
manコマンドや--helpなどがあるけどこれ以外に、aproposがあってこいつは、キーワードから、指定されたキーワードのインスタンス(ツールそのものや、ツールの設定ファイルとかも含む)について説明を検索できるよ。
> `apropos <keyword>`

基本的には、各コマンドの使い方は、helpとmanual(man)を見ればわかるから基本はそこ見て、最終手段で検索使おうな！！！！！！！！！

## システム情報の取得
| コマンド   | 説明                                                                                              |
|-----------|---------------------------------------------------------------------------------------------------|
| whoami    | 現在のユーザー名を表示します。                                                                     |
| id        | ユーザーのIDを返します。                                                                          |
| hostname  | 現在のホスト システムの名前を設定または印刷します。                                               |
| uname     | オペレーティング システム名とシステム ハードウェアに関する基本情報を出力します。                  |
| pwd       | 作業ディレクトリ名を返します。                                                                    |
| ifconfig  | ifconfig ユーティリティは、ネットワーク インターフェイスにアドレスを割り当てたり、アドレスを表示したり、ネットワーク インターフェイス パラメータを構成したりするために使用されます。 |
| ip        | Ip は、ルーティング、ネットワーク デバイス、インターフェイス、およびトンネルを表示または操作するためのユーティリティです。 |
| netstat   | ネットワークのステータスを表示します。                                                            |
| ss        | ソケットを調査するための別のユーティリティ。                                                       |
| ps        | プロセスのステータスを表示します。                                                                 |
| who       | ログインしているユーザーを表示します。                                                            |
| env       | 環境を印刷するか、コマンドを設定して実行します。                                                  |
| lsblk     | ブロックデバイスを一覧表示します。                                                                |
| lsusb     | USBデバイスを一覧表示します。                                                                     |
| lsof      | 開いているファイルを一覧表示します。                                                              |
| lspci     | PCI デバイスを一覧表示します。                                                                    |
| arp -a    | ARPテーブルを表示するよ。|

### 全部重要だけど、この中でも特に説明したいもの
* whoami
Windows と Linux の両方のシステムで使用して、現在のユーザー名を取得できます。セキュリティ評価中に、ホストでリバース シェル アクセスを取得します。状況認識で最初に行うべきことの 1 つは、どのユーザーとして実行しているかを把握すること.
逆に言えば、実際の攻撃者もこのようにwhoami等で確認する可能性が高いので、これは、IoCになるのかな(この前の一連の動きも照らし合わせての話だけど)(そもそもセキュリティ評価の仕方は、攻撃を模したものだから、逆にとかじゃないね)

* uname
カーネル名、ホスト名、カーネル リリース、カーネル バージョン、マシン ハードウェア名、オペレーティング システムがわかる。特に、カーネルのリリースがわかれば、カーネルエクスプロイト等ができる可能性があるのでこいつは調べるべき
> ```
> uname -a (全表示)
> uname -r (カーネルのリリースのみ表示)

* env
こいつは、実行しているログインの環境変数の情報を出力してくれるよ。これを見ると、どこにそのユーザが使っているもしくは、使えるツール(PATH変数の情報)、メールディレクトリ等々がわかり、また、ターミナルの種類(TERM環境変数の情報)がわかるよ！！

### これ以外でとれるシステム情報
特に、ネットワークで使える情報として、「/etc/hosts」ファイルがある。
こいつで、Webサーバなどのサーバの内部向けのサービスにアクセスできたり、ネットワーク内の構成の解明につながる。

あと、システム情報か知らないけど、「/etc/passwd」とか「/etc/shadow」、「/etc/groups」があるよ

## ナビゲーション
ナビゲーションは、標準的な Windows ユーザーとしてマウスを操作するのと同じように不可欠だよー
っていっても「ls」と「pwd」ぐらいだよー

あとは、画面を見やすくする「clear」使ったら楽だよ
### 重要なこと
個人的に攻撃時に、特にホームディレクトリ配下は、ユーザのキャッシュや、sshの公開鍵認証のカギなどがある可能性があるので、絶対に「ls -la」で表示しろしろしろ塩！！！！

### なぜか説明に出てきた/dev/shmについて
/dev/shm は、Linuxシステムにおける一時的な共有メモリのためのディレクトリだよ。このディレクトリは、通常、tmpfs（メモリベースのファイルシステム）としてマウントされており、RAMを使用してファイルを保存できるんだ。

主な特徴としては：
* 高速性: RAM上にあるため、ディスクI/Oよりもはるかに高速なアクセスが可能！
* 一時的なストレージ: 再起動すると内容は消えるため、一時的なデータを保存するのに適している
* 共有メモリ: プロセス間でのデータ共有に利用されることが多く、特にIPC（プロセス間通信）の用途で使われる。

> 例えば、アプリケーションが一時的に大きなデータを格納したり、他のプロセスとデータを共有するために使用されることがある。

なんか、共有メモリのところで認証用のプロセスとかがそこを利用していたら、認証情報とか取れそうだけどどうなんだろ(lsass的な)
あと、ここに実行ファイルを置いて実行したら、シャットダウンとかされたとき、存在を消せるようになるよね(プロセスも消えるけど)



