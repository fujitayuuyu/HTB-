# 1 ADで使用されるプロトコル
## (1) プロトコル一覧
### ① Kerberos
#### ◇ 使用ポート 
TCP/UDP 88
#### ◇ Kerberos認証のプロセス
![image](https://github.com/user-attachments/assets/eea817b9-70b5-4713-a5b8-557ff32c43c9)

### ② DNS(AD DS)
#### ◇ 使用ポート
TCP/UDP 53
#### ◇ AD DS
Active Directory ドメイン サービス (AD DS) は、DNS を使用して、クライアント (ワークステーション、サーバー、およびドメインと通信するその他のシステム) がドメイン コントローラーを見つけられるようにし、ディレクトリ サービスをホストするドメイン コントローラーが相互に通信できるようにする。

#### ◇ サービスレコードについて
サービス レコード (SRV) の形式で、ネットワーク上で実行されているサービスのデータベースを維持します。  
これらのサービス レコードにより、AD 環境のクライアントは、ファイル サーバー、プリンター、またはドメイン コントローラーなど、必要なサービスを見つけられる。  

### ③ LDAP
#### ◇ 使用ポート
LDAP ： tcp/389 , LDAP over SSL ： tcp/636

#### ◇ LDAPとは
ディレクトリ サーバー ⇒　Active Directory は LDAP プロトコルを使用するディレクトリ サーバー  

#### ◇ LDAPの利用
LDAP は、ディレクトリ サービスを提供する他のサーバーと通信するためにアプリケーションが使用する言語。  
⇒ 言い換えると、LDAP は、ネットワーク環境内のシステムが AD と「対話」する方法  
![image](https://github.com/user-attachments/assets/5e251096-d496-47ba-8f94-90fcec213e62)


#### ◇ LDAP認証のプロセス
LDAPサーバは、「BIND」操作を使用して AD に対して資格情報を認証し、LDAP セッションの認証状態を設定するように設定されている。

### ④ MSRPC
#### ◇ 使用ポート
MS-RPCエンドポイントマッパー（RPCSS） : TCP/135 , 実際に使用されるポート : 動的に割り当てられる   
　  
使用するポートは Windows の「MS-RPC エンドポイントマッパー」という機能が管理していて、  
ポート135にアクセスすることで、使用ポートを知ることができる。  

#### ◇ 主要なRPCインターフェース
| インターフェース名 | 説明 |
| --- | --- |
| **lsarpc** | Local Security Authority (LSA)システムへのRPC呼び出しセット。ローカルおよびドメインセキュリティポリシーの管理を行う。 |
| **netlogon** | ドメイン環境内でユーザー認証を行うWindowsプロセス。バックグラウンドで常時実行される。 |
| **samr** | ドメインアカウントデータベースを管理するリモートSAMプロトコル。攻撃者はこれを利用して内部ドメインの偵察を行うことが可能。 |
| **drsuapi** | Active Directoryのレプリケーションを行うためのMicrosoft API。NTDS.ditファイルを複製し、ドメインアカウントのパスワードハッシュを取得するために利用される。 |

#### ◇ (ペネトレーションテスト視点）

| インターフェース名 | 説明 |
| --- | --- |
| **lsarpc** |攻撃者はこれを利用して、ドメインセキュリティ情報や権限の取得を試みる。 |
| **netlogon** | 攻撃者はこのサービスを悪用して、認証バイパスや不正アクセスを試みる可能性がある。 |
| **samr** | このプロトコルを使い、攻撃者はユーザー、グループ、コンピュータ情報を収集し、内部ドメインの偵察を行う。ツールとしてはBloodHoundが有名で、これにより「攻撃パス」の作成が可能。リモートSAMクエリを管理者のみに制限することで対策ができる。 |
| **drsuapi** | 攻撃者はこのAPIを利用して、ADドメインのNTDS.ditファイルをコピーし、全アカウントのパスワードハッシュを取得することが可能。これにより、Pass-the-Hash攻撃や、Hashcatを用いたオフラインパスワードクラックが実行され、RDPやWinRMを通じてシステムへの不正アクセスが可能になる。 |

## (2) NTLM認証
### ① NTLM認証とは
Kerberos と LDAP 以外にも、Active Directory では、AD のアプリケーションやサービスで使用 (および悪用) できる他の認証方法の一つ  
LM と NTLM はハッシュ名であり、NTLMv1 と NTLMv2 は LM または NT ハッシュを利用する認証プロトコル  
ドメインユーザの認証(パススルー認証)だけでなくローカルユーザの認証でも利用できる。
　  
※2023年10月11日時点で、MicrosoftはWindowsで「NTLM（NT LAN Manager）認証」を廃止する方針を明らかにしている。
### ② NTLMの使用ポート
#### ◇ ローカルユーザの認証
ユーザと認証サーバ間 ： tcp/445 (SMB)   
![image](https://github.com/user-attachments/assets/a71575dc-7f48-4c15-808c-54ec9b577f2f)

#### ◇ ドメインユーザの認証(パススルー認証)
ユーザと認証サーバ間 ： tcp/445 (SMB), 認証サーバとDC間 ： tcp/135 + random port (MS-RPC)
![image](https://github.com/user-attachments/assets/3bc3bc3d-24dc-4146-8fa1-3ebf01b84254)


### ③ NTLMによるドメインユーザの認証(パススルー認証)を詳しく
![image](https://github.com/user-attachments/assets/1ec2a066-2458-4b87-8784-2c898aa10ee8)

### ④ NTLM認証要求
![image](https://github.com/user-attachments/assets/5c9895ca-c3f9-4b0c-b473-ee8216d9400e)

#### ◇ NTLM認証の仕組み、参考サイト
https://milestone-of-se.nesuke.com/sv-basic/windows-basic/ntlm-auth-sequence/

#### ◇ NTLMハッシュの形式(読み取り方)
```
Rachel:500:aad3c435b514a4eeaad3b935b51304fe:e46b9e548fa0d122de7f59fb6d48eaa2:::
```
* `Rachel:500`  
ユーザー名はRachel、相対識別子（RID）は、500です。500はadministratorアカウントの既知のRIDです。
* `aad3c435b514a4eeaad3b935b51304fe`  
LMハッシュであり、システム上でLMハッシュが無効になっている場合は、何にも使用できない。
* `e46b9e548fa0d122de7f59fb6d48eaa2`  
NT ハッシュです。このハッシュは、オフラインで解読してクリアテキスト値を明らかにするか (パスワードの長さ/強度によって異なります)、またはパスザハッシュ攻撃に使用できます。

#### ◇ CrackMapExecツールによるPass the Hash攻撃の利用
```
 crackmapexec smb 10.129.41.19 -u rachel -H e46b9e548fa0d122de7f59fb6d48eaa2
```
 　  
CrackMapExecのURL　：https://github.com/byt3bl33d3r/CrackMapExec
#### ◇ NTLMv1プロトコルについて
ネットワークの認証に使用されて、Net-NTLMv1 ハッシュ自体はチャレンジ/レスポンス アルゴリズムから作成されます。サーバーはクライアントに 8 バイトの乱数 (チャレンジ) を送信し、クライアントは 24 バイトのレスポンスを返します。だから、ここで受け取ったハッシュは、pass-the-hash攻撃には利用できない

#### ◇ NTLMv1に対する攻撃
ResponderなどのツールやNTLMリレー攻撃を利用し、ハッシュをキャプチャした後、オフラインで解析して認証情報を奪取することができる  
　  
Responder ：https://github.com/lgandx/Responder  
NTLMリレー攻撃について ：https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html  

#### ◇ NTLMv2について
NTLMv2 はクラックしにくくされ、複数のステージで構成されるより堅牢なアルゴリズムになった。

### ⑤ ドメインキャッシュされた資格情報(MSCache2)
#### ◇ ドメインユーザ認証後のユーザの動き
ホストは、マシンに正常にログインしたドメイン ユーザーのハッシュをレジストリ キーに保存する。  
※これらのハッシュは、Pass-The-Hashには利用できない  
　  
参考：https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials
#### ◇ MSCache2の解析
ハッシュは、非常に強力な GPU クラッキング リグを使用しても、Hashcat などのツールで解読するのに非常に時間がかかるため、これらのハッシュを解読するには、通常、非常にターゲットを絞るか、非常に弱いパスワードを使用する必要がある。

#### ◇ MSCacheのデフォルトで保存できるハッシュの数
10個
### ⑥ 侵入テスターとして
侵入テスト担当者として、AD 環境を評価する際に遭遇する可能性のあるさまざまな種類のハッシュ、その長所、短所、悪用される可能性がある方法を理解することが不可欠!!  
攻撃ができる場合 (クリアテキスト、パスザハッシュ、またはリレーへのクラッキング)、および攻撃が無駄になる可能性がある場合 (つまり、ドメイン キャッシュ資格情報のセットをクラッキングしようとして数日を費やす場合)しっかり判断できるようになろう。

# 2 ユーザについて
## (1) ユーザアカウントとマシンアカウント
### ① ユーザアカウントについて
ローカル システム (AD に参加していない) と Active Directory の両方で作成される。
#### ◇ 目的
個人またはプログラム (システム サービスなど) が権限に基づいてコンピューターにログオンしてリソースにアクセスできるようにすること

#### ◇ グループについて
ユーザーは、1 人以上のメンバーを含むグループに割り当てることができる。  
グループごとに権限を割り当てることで、管理が簡素化され、ユーザー権限の付与と取り消しが容易になる。

### ② ローカルアカウントについて
#### ◇ ローカルアカウントとは
特定のサーバーまたはワークステーションのローカルに保存される。

#### ◇ ローカルアカウントの権限
個別に、またはグループ メンバーシップを介して、そのホストでの権限を割り当てることができます。  
割り当てられた権限は、その特定のホストにのみ付与でき、ドメイン全体では機能しません。  

#### ◇ デフォルトのローカルユーザ
| アカウント名 | 説明 |
| --- | --- |
| **Administrator** | Windowsインストール時に作成される初期アカウント。すべてのリソースを完全に制御。削除不可だが無効化や名前変更は可能。 |
| **Guest** | デフォルトで無効のアカウント。制限されたアクセスを一時的に提供。セキュリティリスクがあるため、無効推奨。 |
| **SYSTEM** | 最も権限の高い内部アカウント。システム機能の多くを実行し、全ファイルにアクセス可能。 |
| **Network Service** | リモートサービスに資格情報を提供するためのアカウント。 サービス コントロール マネージャー (SCM) が Windows サービスを実行するために使用する。 |
| **Local Service** | 最小限の権限で実行され、匿名でネットワークにアクセスするアカウント。 |

### ③ ドメインユーザについて
#### ◇ ドメインユーザに与えられる権限
ユーザー アカウントまたはそのアカウントが所属するグループに付与されたアクセス許可に基づいて、  
ファイル サーバー、プリンター、イントラネット ホスト、その他のオブジェクトなどのリソースにアクセスする権限がドメインから付与される。

#### ◇ ドメインユーザへのログイン
任意のマシンから、ドメイン内の任意のホストにログインできる！！

#### ◇ ADのビルトインユーザ、グループ
| アカウント名         | 説明 |
|----------------------|------|
| **Administrator**     | ドメイン内で最も権限の高いアカウント。すべてのリソースにフルコントロールを持ち、削除不可。通常、別の管理アカウントを作成し、こちらを無効化することが推奨される。 |
| **Guest**             | 一時的なアクセスを許可するアカウント。非常に制限された権限を持ち、デフォルトで無効化されている。セキュリティリスクを避けるため、無効のままにするのが推奨される。 |
| **krbtgt**            | Kerberos 認証で使用されるアカウント。通常は直接使用されず、パスワードを定期的に変更することが推奨される。侵害されると深刻なセキュリティリスクを伴う。 |
| **Domain Admins**     | ドメイン全体の管理権限を持つアカウントグループ。すべてのドメインリソースにアクセス可能。セキュリティのため、使用者は最小限に制限するのが望ましい。 |
| **Enterprise Admins** | フォレスト全体を管理できるアカウントグループ。ドメイン間をまたいだ権限を持ち、非常に強力な管理者権限を持つ。使用には慎重な管理が必要。 |


参考 ：https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-accounts

#### ◇ ADの侵害方法(kerberos)
* `krbtgt`の奪取によるチケット発行(ゴールデンチケット攻撃)(最大10年の有効期限をつけられる)
* DC 上の管理者アカウントの奪取によるDCSync攻撃
* ユーザの保存しているチケットやなりすまし攻撃でゲットしたチケットを用いた、pass-the-ticket攻撃
* SPNを持つユーザにTGTを用いた要求したり、ネットワーク盗聴で取得したTGSをオフラインクラックすることによる資格情報の奪取(Kerberoastring攻撃)  
URL ：https://www.rapid7.com/ja/fundamentals/kerberoasting-attack/#kerberoasting%E6%94%BB%E6%92%83%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF

などなど
#### ◇ ユーザ名の属性
| 属性名              | 説明 |
|---------------------|------|
| **UserPrincipalName（UPN）** | ユーザーのプライマリログオン名で、通常はメールアドレス形式。 |
| **ObjectGUID**       | ユーザーの一意の識別子で、削除されても一意性が維持される。 |
| **SAMAccountName**   | 古いWindowsクライアントとサーバーでサポートされるログオン名。 |
| **objectSID**        | ユーザーのセキュリティ識別子（SID）。サーバーとのセキュリティ対話中にユーザーを識別する。 |
| **sIDHistory**       | 別のドメインから移行された場合、以前のSIDがここに保存される。移行シナリオで使用。 |

### ③ ドメインに参加しているマシンとしていないマシン
#### ■ ドメインに参加している
##### ◇ リソースの共有やポリシーの管理
企業内での情報共有が容易になり、リソース、ポリシー、および更新を収集するための中央管理ポイント (DC) が提供される。  
ドメインに参加しているホストは、ドメインのグループ ポリシーを通じて必要な構成や変更を取得する。  

##### ◇ ドメイン参加の利点
ドメイン内のユーザーは、自分が作業しているホストだけでなく、ドメインに参加している任意のホストにログインしてリソースにアクセスできることです。  
これは、エンタープライズ環境でよく見られる設定です。

##### ◇ ユーザの管理
各ドメインのドメイン管理者が、一元管理する。

#### ■ ドメインに参加していない
##### ◇ リソースの共有やポリシーの管理
ドメインに参加していないコンピュータやworkgroupドメイン内のコンピュータは、ドメイン ポリシーによって管理されない。  
ローカル ネットワーク外でリソースを共有することは、ドメイン内よりもはるかに複雑  

##### ◇ ワークグループの適するところ
同じ LAN 上の家庭用コンピュータや小規模ビジネス クラスター

##### ◇ ユーザの管理
個々のホストで行う。ワークグループ コンピュータ上のユーザー アカウントは、そのホストにのみ存在し、プロファイルはワークグループ内の他のホストに移行されない。

#### ■ 留意すべき点
##### ◇ SYSTEMアカウントレベルのアクセスについて
**AD 環境**のマシン上の`NT AUTHORITY\SYSTEM`レベルのアクセスには、**標準のドメイン ユーザーアカウントとほぼ同じ権限がある**ことに留意

##### ◇ SYSTEMアカウントにできること
特定のホスト上の機密データ (パスワード、SSH キー、機密ファイルなど) を略奪ができる。  
それらの機密データからAD参加しているホストの認証情報を見つけ出すことで、ADへの侵害の入り口に立つことができる。  

## (2) ADのグループ
### ① グループの種類
#### ◇ Securityグループ
ユーザーのコレクションに権限と権利を簡単に割り当てられるようにするためのもの。  
⇒　権限、権利、付与するセキュリティポリシーを管理するために利用するグループタイプ

#### ◇ Distributionグループ
Microsoft Exchange などの電子メール アプリケーションでグループ メンバーにメッセージを配信するために使用。  
⇒ ほぼメーリングリストとか用、Microsoft Outlook で電子メールを作成するときに [宛先] フィールドに電子メールを自動的に追加できる

### ② グループスコープ
#### ◇ ドメインローカルグループ
* ドメイン ローカル グループは、作成されたドメイン内のドメイン リソースへのアクセス許可を管理するためにのみ使用。
* ローカルグループは他のドメインでは使用できないが、他のドメインのユーザーを含めることはできる。
* ローカルグループは他のローカルグループをメンバーにできる。
* グローバルグループをメンバーにはできない。

#### ◇ グローバルグループ
* 他のドメインのリソースへのアクセスを許可できる。
* グローバル グループは、他のグローバル グループとローカル グループの両方に追加できる。

#### ◇ ユニバーサルグループグループ
* ユニバーサル グループ スコープは、複数のドメインに分散されたリソースを管理するために使用でき、同じforestのドメイン内の任意のオブジェクトに対するアクセス許可を付与できる。
* 組織内のすべてのドメインで使用でき、任意のドメインのユーザーを含めることができる。

### ③ ビルトイングループとカスタムグループ
#### ◇ ビルトイングループ
* ドメインの作成時に、ドメインローカルグループスコープを持つ組み込みのセキュリティグループがいくつか作成される。
* これらの組み込みグループには、グループのネスト (グループ内のグループ) が許可されていないため、ユーザアカウントのみに追加できる。

参照 ：https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#about-active-directory-groups

#### ◇ カスタムグループ
独自の目的で追加のグループ (セキュリティと配布の両方) を作成するのが一般的。  
AD 環境の変更/追加によって、追加のグループが作成されることもある ↓
#### 例：
Microsoft Exchange がドメインに追加されると、さまざまなセキュリティ グループがドメインに追加されます。これらのグループの一部には高度な権限が付与されており、適切に管理されていない場合は、ドメイン内での特権アクセスの取得に使用できる。

### ④ ネスト化されたグループメンバーシップ
前述のように、ドメイン ローカル グループは同じドメイン内の別のドメイン ローカル グループのメンバーになることができる。

#### ◇ 留意点
* このメンバーシップを通じて、ユーザーは、自分のアカウントや直接メンバーになっているグループに直接割り当てられていない権限ではなく、自分のグループがメンバーになっているグループの権限を継承する場合がある。
* これによる微妙な構成ミスで、ADへの侵害を進めることができる

#### ◇ 解析に利用できるツール(BloodHound)
sharphoundをADに参加しているサーバで実行させてデータを収集し、bloodhoundに読み込むことで使用できる。

#### ◇ 重要なグループ属性
| 属性名      | 説明 |
|-------------|------|
| **cn**      | グループのCommon-Name (グループの名前)。 |
| **member**  | グループのメンバーであるユーザー、グループ、および連絡先オブジェクト。 |
| **groupType** | グループの種類と範囲を指定する整数値。 |
| **memberOf** | グループがメンバーとして含まれている他のグループ（ネストされたメンバーシップ）。 |
| **objectSid** | グループのセキュリティ識別子 (SID)、グループを識別するための一意の値。

さまざまなグループ タイプを使用して、単一のドメインで、また信頼境界を越えて攻撃を実行する方法を理解することは、非常に役立つ知識だぜ

## (3) Active Directory の権限と特権
権利と特権は AD 管理の基礎であり、管理を誤ると、攻撃者や侵入テスターに​​よる悪用につながる可能性がある。

### ① ビルトインADグループ
参考 ：https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups

| グループ名                     | 説明 |
|--------------------------------|------|
| **Account Operators**          | ユーザー、ローカル グループ、グローバル グループを作成・変更可能。管理者アカウントや特定の管理グループのメンバー管理は不可。 |
| **Administrators**             | ドメイン全体およびコンピューターへの完全なアクセス権を持つ。 |
| **Backup Operators**           | ファイルのバックアップ・復元が可能で、DC にローカルログオン可能。 |
| **DnsAdmins**                  | ドメイン内の DNS 情報へのアクセス権を持つ。 |
| **Domain Admins**              | ドメイン管理全般に完全なアクセス権を持ち、すべてのマシンのローカル管理者グループのメンバー。 |
| **Domain Computers**           | ドメイン内のすべてのコンピューターが含まれる（ドメイン コントローラーを除く）。 |
| **Domain Controllers**         | すべてのドメイン コントローラーが含まれる。 |
| **Domain Guests**              | ドメイン内のゲスト アカウントを含む。 |
| **Domain Users**               | すべてのユーザー アカウントが含まれる。 |
| **Enterprise Admins**          | フォレスト内のすべてのドメインに対して完全な構成アクセスを持つ。 |
| **Event Log Readers**          | ローカル コンピューターのイベント ログを読み取ることができる。 |
| **Group Policy Creator Owners**| グループ ポリシー オブジェクトの作成・編集・削除が可能。 |
| **Hyper-V Administrators**     | Hyper-V の全機能に完全なアクセス権を持つ。 |
| **IIS_IUSRS**                  | IIS で使用される組み込みグループ。 |
| **Pre-Windows 2000 Compatible Access** | 旧バージョンの Windows NT との下位互換性を提供。 |
| **Print Operators**            | プリンター管理が可能で、DC にローカルログオン可能。 |
| **Protected Users**            | 資格情報盗難や Kerberos 悪用に対する追加保護が提供される。 |
| **Read-only Domain Controllers**| 読み取り専用ドメイン コントローラーが含まれる。 |
| **Remote Desktop Users**       | リモート デスクトップ接続が許可される。 |
| **Remote Management Users**    | WinRM を通じたリモートアクセスが許可される。 |
| **Schema Admins**              | Active Directory スキーマの変更が可能。 |
| **Server Operators**           | サービス変更や DC 上のファイルのバックアップが可能。 |


### ③ グループの詳細を調べる
#### ◇ 全表示
```
Get-ADGroup -Identity "Server Operators" -Properties *
```
#### ◇ 必要そうなところのみ表示
```
Get-ADGroup -Identity "Domain Admins" -Properties * | select DistinguishedName,GroupCategory,GroupScope,Name,Members
```

### ③ ユーザ権限の割り当て
#### ◇ ユーザ権限の割り当てについて
現在のグループ メンバーシップや、管理者がグループ ポリシー (GPO) 経由で割り当てることができる権限などの他の要素に応じて、ユーザーのアカウントにはさまざまな権限が割り当てられる。

#### ◇ ユーザの権限に割り当てに関する参考URL
https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-rights-assignment

#### ◇ 特にセキュリティ上重要な権限
| 特権                           | 説明 |
|--------------------------------|------|
| **SeRemoteInteractiveLogonRight** | ユーザーにリモート デスクトップ (RDP) 経由でホストにログオンする権限を付与。機密データの取得や権限昇格に悪用される可能性あり。 |
| **SeBackupPrivilege**           | ユーザーがシステム バックアップを作成できる権限。SAM、SYSTEM レジストリ、NTDS.dit などの機密システムファイルのコピー取得に使用される可能性がある。 |
| **SeDebugPrivilege**            | ユーザーがプロセスのメモリをデバッグ・調整する権限。Mimikatz などのツールを使用して LSASS プロセスの資格情報を取得するために悪用可能。 |
| **SeImpersonatePrivilege**      | 特権アカウント (NT AUTHORITY\SYSTEM など) のトークンを偽装する権限。JuicyPotato などのツールで権限昇格に利用可能。 |
| **SeLoadDriverPrivilege**       | ユーザーがデバイス ドライバーをロード/アンロードできる権限。権限昇格やシステムの侵害に悪用される可能性あり。 |
| **SeTakeOwnershipPrivilege**    | プロセスがオブジェクトの所有権を取得する権限。アクセス制限のあるファイルや共有ファイルにアクセスするために悪用される可能性あり。 |

* 悪用する手法
  * https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e
  * https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-abusing-tokens

#### ◇ ログインユーザの権限の表示
```
whoai /priv
```

#### ◇ ペンテスターとして
* 攻撃者および防御者として、Active Directory に組み込まれているセキュリティ グループのメンバーシップを通じてユーザーに付与される権限を理解する必要がある。
* これらのグループの 1 つ以上に、権限が低いと思われるユーザーが追加されていることは珍しくない。
* これらのグループへのアクセスは厳密に制御する必要がある。

#### ◇ 権限やグループ割り当てのベストプラクティス
* 通常、重要なグループのほとんどを空のままにしておき、1 回限りのアクションを実行する必要がある場合、または繰り返しのタスクを設定する必要がある場合のみ、グループにアカウントを追加するのがいい。
* 重要なグループのいずれかに追加されたアカウントや追加の権限が付与されたアカウントは、厳密に制御および監視し、非常に強力なパスワードまたはパスフレーズを割り当て、システム管理者が日常業務を実行するために使用するアカウントとは別にする必要がある。


# 3 ADのセキュリティ
## (1) ADのセキュリティ
ADのデフォルトの状態は、CIA(機密性：Confidentiality、完全性：Availability、可用性、Confidentiality)の完全性と可用性に重心が置かれている。  
⇒　一般的な攻撃に対して AD を強化するために有効化/調整できる Microsoft の組み込み機能を利用することで、バランスを取ることができるようになる。

## (2) ADのセキュリティの強化
### ①  Microsoft Local Administrator Password Solution (LAPS)
#### ◇ LAPSとは
アカウントのパスワードを一定の間隔 (12 時間、24 時間など) でローテーションするように設定できるようにするMicrosoft公式のツール。

#### ◇ パスワードのローテーションによる影響 
AD 環境内の個々のホストが侵害された場合の影響を軽減するのに役立つ。  
しかしながら、組織はこのようなツールだけに頼るべきではありません

#### ◇ 参考
https://www.microsoft.com/en-us/download/details.aspx?id=46899

### ② 監査ポリシーの設定（ログ記録と監視）
#### ◇ ログの記録と監視の意義
すべての組織は、攻撃の兆候となる可能性のある予期しない変更やアクティビティを検出して対処するために、ログ記録と監視を設定する必要！！  
また、侵害された後の調査や復旧でも重要になってくる。

#### ◇ 効果
効果的なログ記録と監視を使用すると、攻撃者または権限のない従業員によるユーザーやコンピューターの追加、AD 内のオブジェクトの変更、アカウント パスワードの変更、権限のない方法や標準外の方法でのシステムへのアクセス、パスワード スプレーなどの攻撃の実行、最新の Kerberos 攻撃などのより高度な攻撃を検出もできる。

### ③ グループポリシーのセキュリティ設定
#### ◇ グループポリシーとは
モジュールの前半で説明したように、グループ ポリシー オブジェクト (GPO) は、OU レベルで特定のユーザー、グループ、およびコンピューターに適用できるポリシー設定の仮想コレクション。  

ADでは、「グループポリシーエディター」で編集できる
#### ◇ 適用できるセキュリティポリシーの例(これらに限定はされない。)
| ポリシー                           | 説明 |
|----------------------------------|------|
| **アカウント ポリシー**            | ユーザー アカウントがドメインとやり取りする方法を管理。パスワード ポリシーやアカウント ロックアウト ポリシー、Kerberos チケットの有効期限などを含む。 |
| **ローカル ポリシー**              | 特定のコンピューターに適用されるセキュリティ ポリシー。セキュリティ イベントの監査、ユーザー権限の割り当て、管理者/ゲスト アカウントの設定などを管理。 |
| **ソフトウェア制限ポリシー**        | ホスト上で実行できるソフトウェアを制御。特定のソフトウェアの実行を制限する。 |
| **アプリケーション制御ポリシー**    | 特定のユーザーやグループに対して、実行可能ファイルを制御。AppLocker を使用して、CMD や PowerShell などの実行をブロックする。 |
| **高度な監査ポリシー構成**         | ファイルのアクセスや変更、アカウントのログオン/ログオフ、ポリシーの変更、権限使用などのアクティビティを監査するための設定。 |

#### ◇ グループポリシーの詳細
https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-policy-settings

### ④　更新管理 (SCCM/WSUS)
#### ◇ 更新管理について
* 適切なパッチ管理は、あらゆる組織にとって、特に Windows/Active Directory システムを実行している組織にとって重要  
* パッチ管理ソリューションは、パッチのタイムリーな展開を保証し、適用範囲を最大限に広げ、ホストが重要なセキュリティ パッチを見逃さないようにするのに役立つ。

#### ◇ WSUS(Windows Server Update Service)
Windows Server にロールとしてインストールでき、Windows システムにパッチを適用する手動タスクを最小限に抑えるために使用できる。

#### ◇ SCCM(System Center Configuration Manager()
* WSUS Windows Server ロールのインストールに依存する有料ソリューション
* WSUS 単体よりも多くの機能を提供する

#### ◇ 手動によるパッチ適用の問題点
環境の規模によっては非常に長い時間がかかり、システムが見落とされて脆弱なままになる可能性がある。

### ④ アカウント管理
#### ■ グループ管理サービス アカウント (gMSA)
gMSA はドメインによって管理されるアカウントであり、自動的に実行されるが実行には資格情報を必要とする非対話型アプリケーション、サービス、プロセス、およびタスクで使用するための、他の種類のサービス アカウントよりも高いレベルのセキュリティを提供する。

##### ◇ 高いレベルのセキュリティの仕組み
ドメイン コントローラーによって生成される 120 文字のパスワードによる自動パスワード管理を提供します。パスワードは定期的に変更され、どのユーザーも知る必要はありません。これにより、資格情報を複数のホストで使用できるようになります

#### ■ セキュリティグループの参加
ユーザやグループを適切なセキュリティグループに参加させて、ユーザーに一括してきめ細かいアクセス許可を割り当てよう。

#### ■ アカウントの分離
##### ◇ アカウント分離の考え
管理者権限とか重要度の高い権限やグループに属するアカウントと日常業務などの権限が低くてもよいアカウントは、しっかり分けて作ろう。

##### ◇ 必要最小権限の考え
アカウントを役割でしっかりと分けることができたら、それぞれに必要な最小の権限を与えよう!!

##### ◇ アカウント分離、必要最小権限の効果
日常業務などに利用するアカウントと管理者用アカウントを分けていれば、万が一日常業務をしているときに攻撃者による侵害をうけても、攻撃者の行動が制限でき、ドメイン内でかなりのアクセス権を持つ高い権限を持つユーザーの資格情報を奪取されにくくなる。

#### ■ パスワードの複雑さのポリシー、パスフレーズ、２要素認証、多要素認証
##### ◇ パスワードの複雑さのポリシー
標準の複雑さのルール (大文字、小文字、数字、特殊文字の 4 つのうち 3 つ) だけでなく、  
組織は、月や季節、会社名、およびなどの一般的な単語を含むパスワードを許可しないパスワード フィルターの実装も検討する必要がある。

しかしながら、これだけでは、全ての攻撃を守ることはできない。

##### ◇ 理想
* スフレーズを使用
* エンタープライズ パスワード マネージャーを使用してランダムに生成された長いパスワードを使用する
* 任意のホストへのリモート デスクトップ アクセスに多要素認証 (MFA) を実装

２要素認証を行うだけでもかなりセキュリティを高められる。
#### ■ ドメイン管理者アカウントの使用を制限
全能のドメイン管理者アカウントは、ドメイン コントローラーにログインするためにのみ使用し、個人のワークステーション、ジャンプ ホスト、Web サーバーなどには使用しない！！！！！！！！

#### ■ 定期的に古いユーザーとオブジェクトを監査して削除する
##### ◇ 使用されていないや管理されていないアカウントの削除
Active Directory を定期的に監査し、使用されていないアカウントを削除または無効にすることが重要

##### ◇ 使用されていないアカウントのセキュリティ上の問題点
パスワード スプレーなどの攻撃に対する耐性を高めるためにパスワード ポリシーが変更されたとしても、使用されていないアカウントは、ドメイン内での横方向の移動や権限の昇格のための迅速かつ容易な足掛かりまたは手段になる可能性がでてくる。

### ⑥ 監査やログ
#### ■ 権限とアクセスの監査
組織は、ユーザーが日常業務に必要なレベルのアクセスのみを持つように、アクセス制御監査を定期的に実行する必要がある。

##### ◇ 監査する権限やアクセス
攻撃対象領域、ファイル共有アクセス、ユーザー権限 (特定の特権セキュリティ グループのメンバーシップなど) を制限するために、ローカル管理者権限、ドメイン管理者の数 (本当に 30 人も必要でしょうか?)、エンタープライズ管理者を監査することが重要!!!

#### ■ 監査ポリシーとログ
##### ◇ 監査ポリシーとログの意義
堅牢なログ記録と、異常なアクティビティ (パスワード スプレー攻撃の兆候となる可能性のある多数のログイン試行の失敗など) や Kerberoasting 攻撃が試みられていることを示す兆候を検出するルールを使用することで、これを実現できる。Active Directory 列挙の検出にも使用できる。

#### ■ 制限されたグループの使用
##### ◇ 制限されたグループの利用
* 制限されたグループは、ドメイン内のすべてのホスト上のローカル管理者グループのメンバーシップをローカル管理者アカウントと Domain Admins だけに制限して制御する。
* 高度な権限を持つ Enterprise Admins グループと Schema Admins グループおよびその他の重要な管理グループのメンバーシップを制御する

##### ◇ 効果
制限されたグループを利用することで、高度な権限を持つドメイン内、ローカル上のグループのメンバーシップ(アカウントやグループに対する割り当てなど)を制御し、高度な権限を規制することができる。

#### ■ サーバの役割の制限
機密性の高いホストに追加の役割をインストールしないことが重要

##### ◇ なぜか
重要なやつに他の役割をつけちゃうと、そのほかの役割でインストールされたやつが攻撃された場合そのまま機密情報などがとられてしまうから

#### ■ ローカル管理者権限とRDP権限の制限
組織は、どのユーザーがどのコンピューターでローカル管理者権限を持つかを厳重に管理する必要がある。  
しかしながら、1 台以上のホストで Domain Users グループ全体にローカル管理者権限を持たせている組織を私は数多くあるらしい。

##### ◇ 制限の仕方
制限されたグループを用いて制限しよう

##### ◇ ローカル管理者権限を制限しないことのセキュリティ上の問題点
どれかアカウント(権限が非常に低いアカウントでも)を侵害した攻撃者は、権限昇格して、ローカル管理者権限し、機密データを取得したり、別のユーザーがログインしている場合はメモリから高い権限を持つドメイン アカウントの資格情報を盗んだり、横展開する可能性がある。

##### ◇ RDP権限を制限しないことのセキュリティ上の問題点
* 多くのユーザーが 1 台または複数のマシンに RDP できる場合、機密データの漏洩や潜在的な権限昇格攻撃のリスクが高まり、さらに侵害が拡大してしまう。
* リモートデスクトップ接続でローカル管理者権限もあれば、UACの突破は、簡単にできるから権限昇格がしやすくなりやすいよ

## (3) グループポリシーについて
### ① グループポリシーとは
Windows 環境のユーザー アカウントとコンピューター アカウントの両方に適用できる、さまざまな高度な設定を管理者に提供する Windows の機能

### ② GPO(グループポリシーオブジェクト)
#### ◇ GPOとは
ユーザやコンピュータに対して適用できるポリシー設定の仮想コレクション

#### ◇ GPO管理に使用するツール
* グループ ポリシー管理コンソール
*  PowerShellのGroupPolicyモジュール

#### ◇ GPOのポリシーの例
* 画面ロックのタイムアウト
* USB ポートの無効化
* カスタム ドメイン
* パスワード ポリシーの適用
* ソフトウェアのインストール
* アプリケーションの管理
* リモート アクセス設定のカスタマイズ

などなど
#### ◇ GPOで実行できる具体的な操作例
* 個別の GPO を使用して、サービス アカウント、管理者アカウント、標準ユーザー アカウントに異なるパスワード ポリシーを確立する
* リムーバブルメディアデバイス（USBデバイスなど）の使用を禁止する
* スクリーンセーバーにパスワードを強制する
* cmd.exeやPowerShellなど、標準ユーザーには必要のないアプリケーションへのアクセスを制限する
* 監査およびログ記録ポリシーの適用
* 特定の種類のプログラムやスクリプトの実行をユーザーからブロックする
* ドメイン全体にソフトウェアを展開する
* 承認されていないソフトウェアのインストールをユーザーからブロックする
* ユーザーがシステムにログインするたびにログオンバナーを表示する
* ドメイン内での LM ハッシュの使用を禁止する
* コンピュータの起動/シャットダウン時、またはユーザーがマシンにログイン/ログアウトしたときにスクリプトを実行する

### ② GPOの優先順位
#### ◇ GPOの優先順位のレベル
| レベル                                     | 説明 |
|--------------------------------------------|------|
| **Local Group Policy**                     | ドメイン外のホストに対してローカルに適用されるポリシー。上位レベルで定義された同様のポリシーがあれば、それにより上書きされる。 |
| **Site Policy**                            | エンタープライズ内の特定のサイトに対して適用されるポリシー。特定のサイトや建物におけるリソースアクセス制御など、独自のポリシーを設定可能。 |
| **Domain-wide Policy**                     | ドメイン全体に適用されるポリシー。パスワードの複雑さやデスクトップ背景の設定、ログイン画面の通知バナーなどが含まれる。 |
| **Organizational Unit (OU)**               | 特定のOUに属するユーザーやコンピュータに適用されるポリシー。役割固有のリソースアクセスやプリンタ設定などがここで管理される。 |
| **Any OU Policies nested within other OUs**| ネストされたOUに対して特別な権限を適用するポリシー。特定のユーザーやグループに対して、他とは異なる特定の設定を提供する。 |

#### ◇ GPOの優先順位のぴらみっと
![image](https://github.com/user-attachments/assets/672afdbb-126d-4c64-9e88-0e8e2446c1e8)

※ 権限が異なるポリシーの項目があった場合、**このピラミッドの上層にあるポリシーレベルのものが優先される**  
しかし、GPO で構成された設定は、上の階層の GPO (Corp OU にリンクされているものを含む) の設定を上書きする例外がある。

#### ■ 優先順位の例外
##### ◇ 強制オプション
特定の上位のGPOのポリシー設定を強制するために、「強制(Enforced)」 オプションを指定できる。  

* 上位のGPOのポリシー設定を下位の(OUなど)GPOポリシーによって上書きできないように、強制する。
* GPOがドメインレベルで設定され、「強制」オプションが選択されている場合、そのGPOに含まれる設定はドメイン内のすべてのOUに適用され、下位レベルのOUポリシーによって上書きされることがなくなる。

##### ◇ 継承ブロックオプション
OU の上位に適用された GPO がOUに適用させなくすることができるオプション。

### ④ グループポリシーの更新頻度
#### ◇ デフォルトの更新頻度
既定では、ユーザーとコンピューターに対して 90 分ごとに +/- 30 分のランダムなオフセットで実行される。

#### ◇ すぐにポリシーを適用する場合
以下をドメイン管理者で実行する必要がある。
```
gpupdate /force
```

